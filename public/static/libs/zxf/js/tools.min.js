!function(global,document){"use strict";var FormHandle={init:function(){this.initConfig();this.initRules();this.initFileInputs();this.initFormEvents();this.initFormInterceptor();this.setupLayoutSwitcher()},initConfig:function(){this.config={formSelector:'form',errorClass:'error',errorMessageClass:'error-message',successClass:'success',loadingClass:'loading',formLayouts:['left','top','inline'],requiredFieldClass:'required',filePreview:true,autoValidate:true,validateOnBlur:true,validateOnChange:false,scrollToError:true,scrollOffset:20}},initRules:function(){this.rules={required:{validate:function(value,param,field){if(field.type==='file')return field.files&&field.files.length>0;return!Functions.isEmpty(value)}.bind(this),message:'此项为必填项'},email:{validate:function(value){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)},message:'请输入有效的邮箱地址'},phone:{validate:function(value){return/^1[3-9]\d{9}$/.test(value)},message:'请输入有效的手机号码'},number:{validate:function(value){return!isNaN(value)&&!isNaN(parseFloat(value))},message:'请输入有效的数字'},zh_CN:{validate:function(value){return/^[\u4e00-\u9fa5]+$/.test(value)},message:'请输入中文'},strong_password:{validate:function(value){return/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]{8,20}$/.test(value)},message:'密码必须包含大小写字母和数字，长度8-20位'},same:{validate:function(value,param){const otherField=document.querySelector('[name="'+param+'"]');return otherField&&value===otherField.value},message:function(param){return'必须与'+param+'保持一致'}},file:{validate:function(value,param,field){if(!field.files||field.files.length===0)return false;const file=field.files[0];const allowedExtensions=param.split(',');const fileExt=file.name.split('.').pop().toLowerCase();if(allowedExtensions.length>0){return allowedExtensions.some(ext=>{return fileExt===ext.toLowerCase()})}return true}.bind(this),message:function(param){const exts=param.split(',');if(exts.length>0){return'请上传以下类型的文件: '+exts.join(', ')}return'请上传有效的文件'}},max_size:{validate:function(value,param,field){if(!field.files||field.files.length===0)return false;const file=field.files[0];return file.size<=param*1024*1024},message:function(param){return`文件大小不能超过${param}MB`}},min:{validate:function(value,param){return value.length>=parseInt(param)},message:function(param){return`长度不能少于${param}个字符`}},max:{validate:function(value,param){return value.length<=parseInt(param)},message:function(param){return`长度不能超过${param}个字符`}},len:{validate:function(value,param){const[min,max]=param.split(',').map(Number);return value.length>=min&&value.length<=max},message:function(param){const[min,max]=param.split(',');return`长度必须在${min}到${max}个字符之间`}},between:{validate:function(value,param){const[min,max]=param.split(',').map(Number);const numValue=parseFloat(value);return numValue>=min&&numValue<=max},message:function(param){const[min,max]=param.split(',');return`值必须在${min}到${max}之间`}},in:{validate:function(value,param){const options=param.split(',');return options.includes(value)},message:function(param){const options=param.split(',');return`只能输入以下值:${options.join(', ')}`}},date:{validate:function(value){return/^\d{4}-\d{2}-\d{2}$/.test(value)&&!isNaN(new Date(value).getTime())},message:'请输入有效的日期格式(YYYY-MM-DD)'},url:{validate:function(value){return/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/.test(value)},message:'请输入有效的URL地址'},id_card:{validate:function(value){return/^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$/.test(value)},message:'请输入有效的身份证号码'},postal_code:{validate:function(value){return/^[1-9]\d{5}$/.test(value)},message:'请输入有效的邮政编码'},ip:{validate:function(value){return/^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)$/.test(value)},message:'请输入有效的IP地址'},credit_card:{validate:function(value){value=value.replace(/\s+/g,'');if(!/^\d+$/.test(value))return false;let sum=0;let alternate=false;for(let i=value.length-1;i>=0;i--){let digit=parseInt(value.charAt(i));if(alternate){digit*=2;if(digit>9){digit=(digit%10)+1}}sum+=digit;alternate=!alternate}return sum%10===0},message:'请输入有效的信用卡号'},remote:{validate:async function(value,url,field){let _this=this;if(Functions.isEmpty(value)){return true}try{let join_callback=field.getAttribute('data-join');let tempJson={};if(join_callback){if(typeof join_callback==='string'){if(Functions.is_function(join_callback)){tempJson=window[join_callback](field)}else if(Functions.is_json(join_callback)){join_callback=JSON.parse(join_callback);tempJson=join_callback}}else{console.error('验证规则执行错误:remote');return false}}tempJson[field.getAttribute('name')]=value;const formData=new FormData();for(let key in tempJson){formData.append(key,tempJson[key])}const response=await fetch(url,{method:'POST',body:formData});if(!response.ok){return response.text().then(text=>{if(Functions.is_json(text)){let res=JSON.parse(text);_this.message=response.status+':'+(res.message||res.msg||'请求失败');return false}else{_this.message='远程验证请求失败: '+response.status;return false}})}const result=await response.json();if(result.check||result.code===200){return true}_this.message=result.message||result.msg||'验证失败';return false}catch(error){_this.message='远程验证请求失败: '+error.message;return false}},message:'远程验证失败'},nullable:{validate:function(value,param,field){if(field.type==='file'){return!field.files||field.files.length===0||true}return Functions.isEmpty(value)||true}.bind(this),message:''}}},initFileInputs:function(){document.querySelectorAll('input[type="file"]').forEach(input=>{const wrapper=input.closest('.file-input-wrapper');const fileInfo=wrapper?.querySelector('.file-info');const filePreview=wrapper?.querySelector('.file-preview');input.addEventListener('change',function(e){if(this.files&&this.files.length>0){const file=this.files[0];if(fileInfo){fileInfo.querySelector('span').textContent=`已选择:${file.name}(${(file.size/1024/1024).toFixed(2)}MB)`}if(FormHandle.config.filePreview&&file.type.startsWith('image/')&&filePreview){const reader=new FileReader();reader.onload=function(e){filePreview.src=e.target.result;filePreview.style.display='block'};reader.readAsDataURL(file)}FormHandle.clearError(this)}else{if(fileInfo){fileInfo.querySelector('span').textContent='点击或拖拽文件到此处'}if(filePreview)filePreview.style.display='none'}});if(wrapper){wrapper.addEventListener('dragover',function(e){e.preventDefault();this.style.borderColor='var(--primary-color)';this.style.backgroundColor='rgba(66, 133, 244, 0.05)'});wrapper.addEventListener('dragleave',function(e){e.preventDefault();this.style.borderColor='';this.style.backgroundColor=''});wrapper.addEventListener('drop',function(e){e.preventDefault();this.style.borderColor='';this.style.backgroundColor='';if(e.dataTransfer.files.length>0){input.files=e.dataTransfer.files;const event=new Event('change');input.dispatchEvent(event)}})}})},initFormEvents:function(){document.querySelectorAll('textarea[maxlength], textarea[data-rule*="max"]').forEach(textarea=>{const max=textarea.maxLength||parseInt(textarea.getAttribute('data-rule').match(/max:(\d+)/)?.[1])||0;if(max>0){const counter=textarea.nextElementSibling;if(counter&&counter.classList.contains('form-notice')){textarea.addEventListener('input',function(){counter.textContent=`${this.value.length}/${max}`;if(this.value.length>max*0.9){counter.style.color='var(--warning-color)'}else{counter.style.color='var(--secondary-text)'}});counter.textContent=`${textarea.value.length}/${max}`}}});if(this.config.autoValidate){document.querySelectorAll('[data-rule]').forEach(field=>{if(this.config.validateOnBlur){field.addEventListener('blur',function(){FormHandle.validateField(this)})}if(this.config.validateOnChange){field.addEventListener('input',function(){FormHandle.validateField(this)})}if(field.type==='radio'||field.type==='checkbox'){field.addEventListener('change',function(){FormHandle.validateField(this)})}})}},setupLayoutSwitcher:function(){const switchers=document.querySelectorAll('.layout-switcher');switchers.forEach(switcher=>{const buttons=switcher.querySelectorAll('.layout-btn');buttons.forEach(btn=>{btn.addEventListener('click',function(){buttons.forEach(b=>b.classList.remove('active'));this.classList.add('active')})})})},formSubmit:function(event,form=null){FormHandle.handleFormSubmit(event,form)},initFormInterceptor:function(){const forms=document.querySelectorAll(this.config.formSelector);forms.forEach(form=>{form.addEventListener('submit',function(e){e.preventDefault();FormHandle.handleFormSubmit(e)});const submitButtons=form.querySelectorAll('button[type="submit"], input[type="submit"]');submitButtons.forEach(button=>{button.addEventListener('click',function(e){if(e.target.type==='submit'){e.preventDefault();FormHandle.handleFormSubmit(e)}})});form.addEventListener('keydown',function(e){if(e.key==='Enter'&&e.target.tagName!=='TEXTAREA'&&e.target.type!=='submit'&&e.target.type!=='button'){e.preventDefault();FormHandle.handleFormSubmit(e)}})})},validateField:async function(field,form=null){const rules=field.getAttribute('data-rule')?.split('|').filter(rule=>rule.trim()!=='')||[];if(rules.includes('nullable')){if(field.type==='file'){if(!field.files||field.files.length===0){this.clearError(field);return true}}else if(Functions.isEmpty(field.value)){this.clearError(field);return true}}let isValid=true;let firstErrorMessage='';for(const rule of rules){if(rule==='nullable')continue;let[ruleName,param]=rule.split(':');let ruleDef=this.rules[ruleName];if(!ruleDef){if(ruleName.startsWith('remote(')){ruleName='remote';param=rule.slice(7,-1);ruleDef=this.rules[ruleName]}else{console.warn('未知的验证规则:',ruleName);continue}}let validationResult;let fieldValue=field.value;if(field.type==='checkbox'||field.type==='radio'){if(field.type==='radio'){fieldValue=Functions.getRadioValue(field.name,form)}else{fieldValue=Functions.getCheckboxValue(field.name,form)}}else if(field.type==='file'){fieldValue=field}try{if(ruleName==='remote'){validationResult=await ruleDef.validate(fieldValue,param,field)}else{validationResult=ruleDef.validate(fieldValue,param,field)}if(!validationResult){isValid=false;const message=typeof ruleDef.message==='function'?ruleDef.message(param):ruleDef.message;if(!firstErrorMessage)firstErrorMessage=message;break}}catch(error){console.error('验证规则执行错误:',ruleName,error);isValid=false;if(!firstErrorMessage)firstErrorMessage='验证过程出错';break}}if(!isValid){this.showError(field,firstErrorMessage)}else{this.clearError(field);this.showSuccess(field)}return isValid},showError:function(field,message){if(field.type==='file'){const wrapper=field.closest('.file-input-wrapper');if(wrapper)wrapper.classList.add(this.config.errorClass)}else{field.classList.add(this.config.errorClass)}let errorMessage=this.findErrorMessageElement(field);if(errorMessage){errorMessage.textContent=message;errorMessage.classList.add('show')}},showSuccess:function(field){field.classList.remove(this.config.errorClass);field.classList.add(this.config.successClass);setTimeout(()=>{field.classList.remove(this.config.successClass)},2000)},findErrorMessageElement:function(field){const container=field.closest(".form-control-container");if(container){return container.querySelector("."+this.config.errorMessageClass)}const wrapper=field.closest(".file-input-wrapper");if(wrapper&&wrapper.nextElementSibling&&wrapper.nextElementSibling.classList.contains(this.config.errorMessageClass)){return wrapper.nextElementSibling}if(field.nextElementSibling&&field.nextElementSibling.classList.contains(this.config.errorMessageClass)){return field.nextElementSibling}const parent=field.closest(".form-group, .row");if(parent){let findShowErrorEle=parent.querySelector("."+this.config.errorMessageClass);if(findShowErrorEle){return findShowErrorEle}else{if(field.classList.contains('custom-select')){field.parentElement.insertAdjacentHTML("afterend",`<span class="${this.config.errorMessageClass}"></span>`);return field.parentElement.nextElementSibling}else{field.insertAdjacentHTML("afterend",`<span class="${this.config.errorMessageClass}"></span>`);return field.nextElementSibling}}}return null},clearError:function(field){if(field.type==='file'){const wrapper=field.closest('.file-input-wrapper');if(wrapper)wrapper.classList.remove(this.config.errorClass)}else{field.classList.remove(this.config.errorClass)}let errorMessage=this.findErrorMessageElement(field);if(errorMessage){errorMessage.textContent='';errorMessage.classList.remove('show')}},handleFormSubmit:async function(event,formObj=null){const form=formObj||event.target.closest('form');if(!form)return;let submitButton=null;if(event.type==='click'&&(event.target.type==='submit'||event.target.tagName==='BUTTON')){submitButton=event.target}else{submitButton=form.querySelector('button[type="submit"], input[type="submit"]')}const originalButtonDisabled=submitButton?submitButton.disabled:false;if(submitButton){submitButton.disabled=true;const submitText=submitButton.querySelector('#submitText')||submitButton;submitText.insertAdjacentHTML('afterend','<span class="loading-spinner"></span>')}try{this.clearFormErrors(form);const isValid=await this.validateForm(form);if(!isValid){if(this.config.scrollToError){this.scrollToFirstError(form)}return}const method=form.getAttribute('method')||'POST';let useAjax=form.hasAttribute("use-ajax")||method.toUpperCase()==="POST";if(form.hasAttribute('not-use-ajax')){useAjax=false}if(typeof(form_before)==="function"){if(form_before(event)===false){return false}}if(useAjax){await this.submitFormViaAjax(form,submitButton)}else{form.submit()}}catch(error){console.error('表单提交错误:',error);this.showFormError(form,'表单提交过程中出错，请重试')}finally{if(submitButton){submitButton.disabled=originalButtonDisabled;const spinner=submitButton.querySelector('.loading-spinner');if(spinner)spinner.remove()}}},getDivFormData:function(target,options={}){const{includeEmpty=false,includeDisabled=false,includeReadonly=false,ignoreTypes=['hidden','button','submit','reset','image'],booleanFields=true}=options;const form=typeof target==='string'?document.querySelector(target):target;if(!form)return{};const fieldSelector=['input:not([type="'+ignoreTypes.join('"]):not([type="')+'"])','textarea','select'].join(',');return Array.from(form.elements||form.querySelectorAll(fieldSelector)).reduce((data,element)=>{if((!includeDisabled&&element.disabled)||(!includeReadonly&&element.readOnly)){return data}const{name,type,checked,value,multiple,selectedOptions}=element;if(!name&&!includeEmpty)return data;let fieldValue;switch(true){case type==='checkbox':fieldValue=booleanFields?checked:(checked?value:undefined);break;case type==='radio':if(!checked)return includeEmpty?{...data,[name]:undefined}:data;fieldValue=value;break;case multiple:fieldValue=Array.from(selectedOptions).map(opt=>opt.value);break;default:fieldValue=value}if(includeEmpty||(fieldValue!==undefined&&fieldValue!=='')){data[name]=fieldValue}return data},{})},getFormData:function(form,options={}){if(!form){console.error('未找到表单元素');return null}const formElement=typeof form==='string'?document.querySelector(form):form;if(!formElement||!formElement.tagName||formElement.tagName!=='FORM'){throw new Error('Invalid form element provided');}const{includeDisabled=false,includeEmpty=true,includeButtons=false,filter=null}=options;const hasFile=Array.from(formElement.elements).some(el=>el.type==='file'&&el.files.length>0);const formDataObj=hasFile?new FormData():new URLSearchParams();const resultObject={};Array.from(formElement.elements).forEach(element=>{const{tagName,type,name,disabled,value,checked,multiple,files}=element;if(!name||(!includeDisabled&&disabled)||(!includeButtons&&(tagName==='BUTTON'||(tagName==='INPUT'&&(type==='button'||type==='submit'||type==='reset'))))||(filter&&!filter(element))){return}let values=[];if(tagName==='SELECT'){const options=element.selectedOptions;values=multiple?Array.from(options).map(opt=>opt.value):(element.selectedIndex>=0?[options[0].value]:[])}else if(type==='checkbox'){if(checked)values=[value||'on']}else if(type==='radio'){if(checked)values=[value||'on']}else if(type==='file'){values=files.length>0?Array.from(files):[]}else{values=[value]}if(!includeEmpty&&values.every(v=>v===''||v===null||v===undefined)){return}values.forEach(val=>{if(hasFile&&type==='file'){formDataObj.append(name,val)}else if(hasFile){formDataObj.append(name,val)}else{formDataObj.append(name,val)}if(!resultObject[name]){resultObject[name]=values.length>1?values:values[0]}})});return hasFile?formDataObj:resultObject},submitFormViaAjax:function(form,submitButton){const action=form.getAttribute('action')||window.location.href;const method=form.getAttribute('method')||'POST';const formData=this.getFormData(form)||{};let config={headers:{'X-Requested-With':'XMLHttpRequest','X-CSRF-TOKEN':Functions.getCsrfToken()||''}};if(formData instanceof FormData){}else{config.headers['Content-Type']='application/x-www-form-urlencoded'}return myTools.http.request(method,action,formData,config).then(data=>{if(typeof(form_after)==="function"){form_after(data)}else{console.log('可以定义一个form_after(resp)方法接管处理AJAX数据',data)}}).catch(error=>{if(typeof(form_after)==="function"){form_after(error)}else{console.log('可以定义一个form_after(resp)方法接管处理AJAX数据',error)}})},validateForm:async function(form){let isValid=true;const fields=form.querySelectorAll('[data-rule]');for(const field of fields){const fieldValid=await this.validateField(field,form);if(!fieldValid){isValid=false}}return isValid},clearFormErrors:function(form){const errorFields=form.querySelectorAll('.'+this.config.errorClass);errorFields.forEach(field=>{if(field.classList.contains(this.config.errorClass)){field.classList.remove(this.config.errorClass)}});const errorMessages=form.querySelectorAll('.'+this.config.errorMessageClass);errorMessages.forEach(msg=>{msg.textContent='';msg.classList.remove('show')})},showFormError:function(form,message){let formError=form.querySelector('.form-error');if(!formError){formError=document.createElement('div');formError.className='error-message form-error';form.insertBefore(formError,form.firstChild)}formError.textContent=message;formError.classList.add('show')},scrollToFirstError:function(form){const firstError=form.querySelector('.'+this.config.errorClass);if(firstError){const element=firstError.tagName==='INPUT'||firstError.tagName==='SELECT'||firstError.tagName==='TEXTAREA'?firstError:firstError.querySelector('input, select, textarea')||firstError;const elementPosition=element.getBoundingClientRect().top;const offsetPosition=elementPosition+window.pageYOffset-this.config.scrollOffset;window.scrollTo({top:offsetPosition,behavior:'smooth'});try{if(element.tagName==='INPUT'||element.tagName==='SELECT'||element.tagName==='TEXTAREA'){element.focus()}}catch(e){console.warn('无法聚焦错误字段:',e)}}},addRule:function(name,rule){if(this.rules[name]){console.warn(`规则"${name}"已存在，将被覆盖`)}this.rules[name]=rule},setConfig:function(config){Object.assign(this.config,config)}};var SelectHandle={init:function(selector='select.custom-select'){const selects=document.querySelectorAll(selector);selects.forEach(select=>{this.createCustomUI(select)});this.addGlobalClickHandler()},createCustomUI:function(select){if(select.classList.contains('has-custom-create-select')){return}select.classList.add('has-custom-create-select');const wrapper=document.createElement('div');wrapper.className='custom-select-wrapper '+(select.className||'');wrapper.className=wrapper.className.replace('form-control','');select.parentNode.insertBefore(wrapper,select);wrapper.appendChild(select);const isMultiple=select.multiple;const isDisabled=select.disabled;const display=this.createDisplayElement(select);const arrow=document.createElement('div');arrow.className='custom-select-arrow';const dropdown=this.createDropdownMenu(select);wrapper.appendChild(display);wrapper.appendChild(arrow);wrapper.appendChild(dropdown);this.updateDisplayState(select,display);this.bindEvents(select,display,dropdown);if(isDisabled){display.classList.add('disabled')}},createDisplayElement:function(select){const display=document.createElement('div');display.className='custom-select-display '+(select.className||'');display.className=display.className.replace('form-control','');display.tabIndex=select.disabled?-1:0;if(select.multiple){const tagsContainer=document.createElement('div');tagsContainer.className='custom-select-tags';display.appendChild(tagsContainer)}const content=document.createElement('div');display.appendChild(content);return display},createDropdownMenu:function(select){const dropdown=document.createElement('div');dropdown.className='custom-select-dropdown';Array.from(select.options).forEach(option=>{const optionElement=document.createElement('div');optionElement.className='custom-select-option';optionElement.textContent=option.text;optionElement.dataset.value=option.value;if(option.selected){optionElement.classList.add('selected')}if(option.disabled){optionElement.classList.add('disabled')}dropdown.appendChild(optionElement)});return dropdown},updateDisplayState:function(select,display){const isMultiple=select.multiple;const content=display.lastChild;if(isMultiple){const tagsContainer=display.querySelector('.custom-select-tags');tagsContainer.innerHTML='';const selectedOptions=Array.from(select.selectedOptions);if(selectedOptions.length>0){selectedOptions.forEach(option=>{const tag=document.createElement('span');tag.className='custom-select-tag';tag.innerHTML=`${option.text}<span class="custom-select-tag-remove"data-value="${option.value}">×</span>`;tagsContainer.appendChild(tag)});content.textContent=''}else{content.textContent='请选择...';content.className='custom-select-placeholder'}}else{const selectedOption=select.options[select.selectedIndex];content.textContent=selectedOption.value?selectedOption.text:'请选择...';content.className=selectedOption.value?'':'custom-select-placeholder'}},bindEvents:function(select,display,dropdown){display.addEventListener('click',e=>{if(select.disabled)return;if(e.target.classList.contains('custom-select-tag-remove'))return;dropdown.classList.toggle('open');display.classList.toggle('open')});dropdown.addEventListener('click',e=>{const optionElement=e.target.closest('.custom-select-option');if(!optionElement||optionElement.classList.contains('disabled'))return;const value=optionElement.dataset.value;if(select.multiple){const option=select.querySelector(`option[value="${value}"]`);if(option){option.selected=!option.selected;optionElement.classList.toggle('selected')}}else{select.value=value;dropdown.querySelectorAll('.custom-select-option').forEach(opt=>{opt.classList.remove('selected')});optionElement.classList.add('selected');dropdown.classList.remove('open');display.classList.remove('open')}this.updateDisplayState(select,display);select.dispatchEvent(new Event('change'))});display.addEventListener('click',e=>{if(e.target.classList.contains('custom-select-tag-remove')){const value=e.target.dataset.value;const option=select.querySelector(`option[value="${value}"]`);if(option){option.selected=false;dropdown.querySelector(`.custom-select-option[data-value="${value}"]`).classList.remove('selected');this.updateDisplayState(select,display);select.dispatchEvent(new Event('change'))}}});select.addEventListener('change',()=>{this.updateDisplayState(select,display);if(select.multiple){const selectedValues=Array.from(select.selectedOptions).map(opt=>opt.value);dropdown.querySelectorAll('.custom-select-option').forEach(opt=>{opt.classList.toggle('selected',selectedValues.includes(opt.dataset.value))})}else{dropdown.querySelectorAll('.custom-select-option').forEach(opt=>{opt.classList.toggle('selected',opt.dataset.value===select.value)})}})},addGlobalClickHandler:function(){document.addEventListener('click',e=>{const openDropdowns=document.querySelectorAll('.custom-select-dropdown.open');openDropdowns.forEach(dropdown=>{const wrapper=dropdown.closest('.custom-select-wrapper');if(!wrapper.contains(e.target)){dropdown.classList.remove('open');wrapper.querySelector('.custom-select-display').classList.remove('open')}})})},destroy:function(selector='select.custom-select'){document.removeEventListener('click',this.handleGlobalClick);document.querySelectorAll(selector).forEach(select=>{const wrapper=select.parentElement;select.classList.remove('custom-select');select.style.position='';select.style.opacity='';select.style.height='';select.style.width='';wrapper.parentNode.insertBefore(select,wrapper);wrapper.remove()})}};var Functions={click(element,callback){document.addEventListener("click",e=>{const clickDom=e.target.closest(element);clickDom&&typeof callback==="function"&&callback(e)},true)},resizeDom(element="body",callback=null){if("ResizeObserver"in window){var tableElement=document.querySelector(element);if(tableElement){var debounceTimer;var resizeObserver=new ResizeObserver(entries=>{for(let entry of entries){if(debounceTimer){clearTimeout(debounceTimer)}debounceTimer=setTimeout(()=>{callback&&callback(entry.contentRect.width,entry.contentRect.height)},1500)}});resizeObserver.observe(tableElement)}else{console.error("未找到元素:",element)}}else{console.error("不支持ResizeObserver")}},copyText:function(text,callback=null){if(navigator.clipboard){navigator.clipboard.writeText(text).then(()=>{console.log("复制成功");callback&&callback()}).catch((err)=>{console.error("无法复制文本: ",err)})}else{const textarea=document.createElement("textarea");textarea.value=text;document.body.appendChild(textarea);textarea.select();try{document.execCommand("copy");console.log("复制成功");callback&&callback()}catch(err){console.error("无法复制文本: ",err)}document.body.removeChild(textarea)}},handleImageFallback:function(defaultImage){if(!defaultImage){console.error("必须提供默认图片URL");return}const processImage=(img)=>{if(img.dataset.fallbackProcessed||img.src===defaultImage){return}img.dataset.fallbackProcessed="true";img.dataset.originalSrc=img.src;const errorHandler=()=>{img.removeEventListener("error",errorHandler);img.src=defaultImage};img.addEventListener("error",errorHandler);if(img.complete&&img.naturalHeight===0){errorHandler()}};const initExistingImages=()=>{document.querySelectorAll("img").forEach(processImage)};const setupObserver=()=>{const observer=new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{mutation.addedNodes.forEach((node)=>{if(node.nodeName==="IMG"){processImage(node)}else if(node.querySelectorAll){node.querySelectorAll("img").forEach(processImage)}})})});observer.observe(document.body,{childList:true,subtree:true});return observer};initExistingImages();return setupObserver()},timestamp:function(dateString=""){return dateString?parseInt((new Date(dateString)).getTime().toString().substr(0,10)):parseInt((new Date()).getTime().toString().substr(0,10))},timestampToDate:function(timestamp,format="y-m-d"){var date_str=timestamp?parseInt(timestamp.toString().substr(0,10)):parseInt((new Date()).getTime().toString().substr(0,10));var date=new Date(date_str*1*1000);format=format?format:"y-m-d";var year=date.getFullYear().toString();var month=date.getMonth()*1+1;var day=date.getDate();var hour=date.getHours();var minute=date.getMinutes();var second=date.getSeconds();var resutl_time=format;if(format.indexOf("y")>-1){resutl_time=resutl_time.replace("y",year)}if(format.indexOf("m")>-1){resutl_time=resutl_time.replace("m",(month>9?month:"0"+month).toString())}if(format.indexOf("d")>-1){resutl_time=resutl_time.replace("d",(day>9?day:"0"+day).toString())}if(format.indexOf("h")>-1){resutl_time=resutl_time.replace("h",(hour>9?hour:"0"+hour).toString())}if(format.indexOf("i")>-1){resutl_time=resutl_time.replace("i",(minute>9?minute:"0"+minute).toString())}if(format.indexOf("s")>-1){resutl_time=resutl_time.replace("s",(second>9?second:"0"+second).toString())}return resutl_time},formatJson:function(input,indent=2){const SPACE=indent>0?" ".repeat(indent):"";const NEWLINE=indent>0?"\n":"";const COLON=indent>0?": ":":";let level=0;const stack=[];const buffer=[];const push=str=>buffer.push(str);const newLine=()=>indent&&push(NEWLINE+SPACE.repeat(level));try{const obj=typeof input==="string"?JSON.parse(input.replace(/'/g,"\"")):input;const format=(value)=>{if(value===null)return push("null");const type=typeof value;if(type==="boolean")return push(value?"true":"false");if(type==="number")return push(Number.isFinite(value)?String(value):"null");if(type==="string")return push(JSON.stringify(value));if(type!=="object")return push("null");if(stack.includes(value))throw new Error("Circular reference");stack.push(value);const isArray=Array.isArray(value);push(isArray?"[":"{");const entries=isArray?value:Object.entries(value);if(entries.length>0){level++;for(let i=0;i<entries.length;i++){newLine();if(!isArray){push(`"${entries[i][0]}"${COLON}`)}format(isArray?entries[i]:entries[i][1]);if(i<entries.length-1){push(",")}}level--;newLine()}push(isArray?"]":"}");stack.pop()};format(obj);return buffer.join("")}catch(error){throw new Error(`JSON格式化失败:${error.message}`)}},getType:function(data){let type=typeof data;if(type!=="object"){return type}return Object.prototype.toString.call(data).replace(/^\[object (\S+)\]$/,"$1")},isEmpty:function(value){if(value==null)return true;switch(true){case typeof value==="string":return value.trim()==="";case typeof value==="number":return Number.isNaN(value)||value===0;case Array.isArray(value):return value.length===0;case typeof value==="object":if(value instanceof Date)return false;if(value instanceof Map||value instanceof Set)return value.size===0;return Object.keys(value).length===0;default:return false}},is_json:function(value){if(typeof value==='object')return true;try{JSON.parse(value);return true}catch(e){return false}},is_function:function(string){return typeof string==='function'||(window.hasOwnProperty(string)&&typeof window[string]==='function')},delhtmltag:function(str){try{str=str?str.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""):"";str=str?str.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,""):"";str=str?$(str).text():""}catch(err){}return str},inArray:function(str,array){return array.includes(str)},getCsrfToken:function(){const meta=document.querySelector("meta[name=\"csrf-token\"]");return meta?meta.getAttribute("content"):null},debounce:function(func,wait,immediate){let timeout,result;const debounced=function(){const context=this;const args=arguments;if(timeout)clearTimeout(timeout);if(immediate){const callNow=!timeout;timeout=setTimeout(()=>{timeout=null},wait);if(callNow)result=func.apply(context,args)}else{timeout=setTimeout(()=>{func.apply(context,args)},wait)}return result};debounced.cancel=function(){clearTimeout(timeout);timeout=null};return debounced},throttle:function(func,wait,options){let timeout,context,args,result;let previous=0;if(!options)options={};const later=function(){previous=options.leading===false?0:Date.now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};const throttled=function(){const now=Date.now();if(!previous&&options.leading===false)previous=now;const remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null}previous=now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result};throttled.cancel=function(){clearTimeout(timeout);previous=0;timeout=context=args=null};return throttled},urlQuery:function(name,location,get_last){get_last=get_last?get_last:true;var url=location?location:window.location.href;var splitIndex=url.indexOf("?")+1;var paramStr=url.substr(splitIndex,url.length);var arr=paramStr.split("&");var lastVal;var allParamData={};for(var i=0;i<arr.length;i++){var kv=arr[i].split("=");if(name){if(kv[0]===name){if(get_last){lastVal=kv[1]}else{return kv[1]}}}else{if(lastVal===undefined){lastVal={}}lastVal[kv[0]]=kv[1]}}return lastVal},replaceString:function(string,options={}){if(myTools.func.isEmpty(string)){return string}for(var key in options){string=string.replace(new RegExp("{"+key+"}","g"),options[key])}return string},getAnchorPoint:function(name){var getTab=window.location.hash;var args=getTab.substring(1).split("&");for(var i=0,len=args.length;i<len;i++){var hashItem=args[i];var item=hashItem.split("=");if(item["0"]===name){return item["1"]||""}}return""},removeHtmlDom:function(htmlString,domName){const parser=new DOMParser();const doc=parser.parseFromString(htmlString,'text/html');const copyCodeBtns=doc.querySelectorAll(domName);copyCodeBtns.forEach(btn=>{btn.parentNode.removeChild(btn)});return doc.body.innerHTML},getRadioValue(name,form=null){const selected=(form===null?document:form).querySelector(`input[name="${name}"]:checked`);return selected?selected.value:null},getCheckboxValue(name,form=null){const selected=(form===null?document:form).querySelectorAll(`input[name="${name}"]:checked`);return Array.from(selected).map(item=>item.value)},};var HttpRequest={defaults:{baseURL:'',timeout:10000,headers:{'Content-Type':'application/json','Accept':'application/json'},responseType:'json',withCredentials:false,},interceptors:{request:[],response:[],error:function(err){console.error('HTTP请求错误:',err)}},config:function(config){Object.assign(this.defaults,config);return this},intercept:function(type,handler){if(this.interceptors[type]!==undefined){if(type==='error'){this.interceptors.error=handler}else{this.interceptors[type].push(handler)}}return this},request:function(method,url,data,config={}){var options=Object.assign({},this.defaults,config);var controller=new AbortController();var timeoutId=setTimeout(function(){controller.abort()},options.timeout);var fullUrl=url.startsWith('http')?url:options.baseURL+url;var requestConfig={method:method.toUpperCase(),headers:new Headers(options.headers),signal:controller.signal,credentials:options.withCredentials?'include':'same-origin'};if(data){if(method.toUpperCase()==='GET'){var params=new URLSearchParams();for(var key in data){if(data[key]!==undefined){params.append(key,data[key])}}fullUrl+=(fullUrl.includes('?')?'&':'?')+params.toString()}else{var contentType=options.headers['Content-Type']||'';if(contentType.includes('application/json')){requestConfig.body=JSON.stringify(data)}else if(contentType.includes('multipart/form-data')){var formData=new FormData();for(var key in data){if(data[key]!==undefined){formData.append(key,data[key])}}requestConfig.body=formData}else if(contentType.includes('application/x-www-form-urlencoded')){var urlEncoded=new URLSearchParams();for(var key in data){if(data[key]!==undefined){urlEncoded.append(key,data[key])}}requestConfig.body=urlEncoded}else{requestConfig.body=data}}}var self=this;return Promise.resolve().then(function(){return self.interceptors.request.reduce(function(chain,interceptor){return chain.then(function(config){return interceptor(config)||config})},Promise.resolve({url:fullUrl,...requestConfig}))}).then(function(finalConfig){fullUrl=finalConfig.url;delete finalConfig.url;requestConfig=finalConfig;return fetch(fullUrl,requestConfig).finally(function(){clearTimeout(timeoutId)})}).then(function(response){return self.interceptors.response.reduce(function(chain,interceptor){return chain.then(function(res){return interceptor(res.clone())||res})},Promise.resolve(response))}).then(function(response){if(!response.ok){return response.text().then(text=>{var error;if(Functions.is_json(text)){let res=JSON.parse(text);error=new Error(response.status+':'+(res.message||res.msg||'请求失败'));error.response=response;throw error;}else{error=new Error('请求失败: '+response.status);error.response=response;throw error;}})}switch(options.responseType){case'json':return response.json();case'text':return response.text();case'blob':return response.blob();case'formData':return response.formData();case'arrayBuffer':return response.arrayBuffer();default:return response}}).catch(function(error){self.interceptors.error(error);throw error;})},download:function(url,filename,config){var downloadConfig=Object.assign({},config,{responseType:'blob'});return this.get(url,null,downloadConfig).then(function(blob){var a=document.createElement('a');var url=window.URL.createObjectURL(blob);a.href=url;a.download=filename||'download';document.body.appendChild(a);a.click();setTimeout(function(){document.body.removeChild(a);window.URL.revokeObjectURL(url)},100)})},upload:function(url,formData,config){var uploadConfig=Object.assign({},config,{headers:{'Content-Type':'multipart/form-data'}});return this.post(url,formData,uploadConfig)},create:function(config){var instance=Object.create(this);instance.defaults=Object.assign({},this.defaults,config);instance.interceptors={request:[...this.interceptors.request],response:[...this.interceptors.response],error:this.interceptors.error};return instance}};['get','post','put','delete','patch','head'].forEach(function(method){HttpRequest[method]=function(url,data,config){return this.request(method,url,data,config)}.bind(HttpRequest)});var Tips={config:{className:'tips-container',arrowClassName:'tips-arrow',allowTypes:['top','bottom','left','right','track'],defaultType:'track',showDelay:60,hideDelay:150,offset:12,trackOffset:{x:0,y:15},maxWidth:300,arrowSize:8,checkViewport:true},tipElement:null,tipArrow:null,currentTarget:null,showTimeout:null,hideTimeout:null,lastPosition:null,scrollListener:null,resizeListener:null,init:function(options){if(options){for(var key in options){if(this.config.hasOwnProperty(key)){this.config[key]=options[key]}}}this.setupListeners();this.setupEventListeners()},setupListeners:function(){if(this.scrollListener){window.removeEventListener('scroll',this.scrollListener)}if(this.resizeListener){window.removeEventListener('resize',this.resizeListener)}this.scrollListener=this.handleScroll.bind(this);this.resizeListener=this.handleResize.bind(this);window.addEventListener('scroll',this.scrollListener,{passive:true});window.addEventListener('resize',this.resizeListener,{passive:true})},handleScroll:function(){if(this.tipElement&&this.tipElement.style.display==='block'){var tipType=this.getCurrentTipType();var target=tipType==='track'?this.lastPosition:this.currentTarget;this.positionTip(target,tipType)}},handleResize:function(){this.handleScroll()},getCurrentTipType:function(){if(!this.tipElement)return this.config.defaultType;for(var i=0;i<this.config.allowTypes.length;i++){if(this.tipElement.classList.contains(this.config.allowTypes[i])){return this.config.allowTypes[i]}}return this.config.defaultType},setupEventListeners:function(){this.removeEventListeners();var elements=document.querySelectorAll('[data-tips]');for(var i=0;i<elements.length;i++){var el=elements[i];if(!el.dataset.tipsInitialized){el.dataset.originalTitle=el.title;el.title='';el.dataset.tipsInitialized='true';el.addEventListener('mouseenter',this.handleMouseEnter.bind(this));el.addEventListener('mouseleave',this.handleMouseLeave.bind(this));el.addEventListener('mousemove',this.handleMouseMove.bind(this))}}},removeEventListeners:function(){var elements=document.querySelectorAll('[data-tips][data-tips-initialized="true"]');for(var i=0;i<elements.length;i++){var el=elements[i];el.removeEventListener('mouseenter',this.handleMouseEnter);el.removeEventListener('mouseleave',this.handleMouseLeave);el.removeEventListener('mousemove',this.handleMouseMove)}},handleMouseEnter:function(e){this.currentTarget=e.currentTarget;clearTimeout(this.hideTimeout);this.updateLastPosition(e);this.showTimeout=setTimeout(function(){this.showTip(this.currentTarget)}.bind(this),this.config.showDelay)},updateLastPosition:function(e){this.lastPosition={x:e.clientX,y:e.clientY,scrollX:window.scrollX||document.documentElement.scrollLeft,scrollY:window.scrollY||document.documentElement.scrollTop,target:e.currentTarget}},handleMouseLeave:function(){clearTimeout(this.showTimeout);this.hideTimeout=setTimeout(function(){this.hideTip()}.bind(this),this.config.hideDelay)},handleMouseMove:function(e){this.updateLastPosition(e);if(this.tipElement&&this.tipElement.classList.contains('track')){if(this.tipElement.style.display==='block'){this.positionTip(this.lastPosition,'track')}}},createTipElement:function(){if(!this.tipElement||!document.body.contains(this.tipElement)){this.tipElement=document.createElement('div');this.tipElement.className=this.config.className;this.tipArrow=document.createElement('div');this.tipArrow.className=this.config.arrowClassName;this.tipElement.appendChild(this.tipArrow);Object.assign(this.tipElement.style,{position:'absolute',maxWidth:this.config.maxWidth+'px',display:'none',zIndex:'9999',pointerEvents:'none'});document.body.appendChild(this.tipElement)}return this.tipElement},showTip:function(target){var content=target.dataset.originalTitle||'';if(!content)return;var tipElement=this.createTipElement();this.setContent(tipElement,content);var tipType=this.getTipType(target);this.forceReflow(tipElement);this.positionTip(tipType==='track'?this.lastPosition:target,tipType);tipElement.classList.add(tipType,'visible');tipElement.style.display='block'},forceReflow:function(element){return element.offsetHeight},hideTip:function(){if(this.tipElement){this.tipElement.classList.remove('visible');setTimeout(function(){if(this.tipElement&&!this.tipElement.classList.contains('visible')){this.tipElement.style.display='none'}}.bind(this),this.config.hideDelay)}},setContent:function(element,content){while(element.childNodes.length>1){element.removeChild(element.lastChild)}var contentWrapper=document.createElement('div');contentWrapper.style.margin='0';contentWrapper.style.padding='0';if(/^[.#]/.test(content)){var targetEl=document.querySelector(content);if(targetEl){var clone=targetEl.cloneNode(true);clone.style.display='block';clone.style.visibility='visible';contentWrapper.appendChild(clone)}}else if(/^</.test(content)){contentWrapper.innerHTML=content}else{var textContent=content.replace(/\n/g,' ').replace(/\\n/g,'\n');var lines=textContent.split('\n');for(var i=0;i<lines.length;i++){if(i>0)contentWrapper.appendChild(document.createElement('br'));contentWrapper.appendChild(document.createTextNode(lines[i]))}}element.appendChild(contentWrapper)},getTipType:function(element){var type=(element.dataset.tips||'').toLowerCase();return this.config.allowTypes.includes(type)?type:this.config.defaultType},positionTip:function(target,type){if(!this.tipElement)return;this.config.allowTypes.forEach(function(t){this.tipElement.classList.remove(t)},this);this.tipElement.classList.add(type);if(type==='track'){this.positionTrackTip(target)}else{this.positionStaticTip(target,type)}},positionStaticTip:function(element,type){var tipRect=this.tipElement.getBoundingClientRect();var targetRect=element.getBoundingClientRect();var scrollX=window.scrollX||document.documentElement.scrollLeft;var scrollY=window.scrollY||document.documentElement.scrollTop;var top=0,left=0;switch(type){case'top':top=targetRect.top+scrollY-tipRect.height-this.config.offset;left=targetRect.left+scrollX+targetRect.width/2-tipRect.width/2;break;case'bottom':top=targetRect.top+scrollY+targetRect.height+this.config.offset;left=targetRect.left+scrollX+targetRect.width/2-tipRect.width/2;break;case'left':top=targetRect.top+scrollY+targetRect.height/2-tipRect.height/2;left=targetRect.left+scrollX-tipRect.width-this.config.offset;break;case'right':top=targetRect.top+scrollY+targetRect.height/2-tipRect.height/2;left=targetRect.left+scrollX+targetRect.width+this.config.offset;break}if(this.config.checkViewport){var viewportWidth=window.innerWidth;var viewportHeight=window.innerHeight;left=Math.max(0,Math.min(left,viewportWidth+scrollX-tipRect.width));top=Math.max(0,Math.min(top,viewportHeight+scrollY-tipRect.height))}this.tipElement.style.left=Math.round(left)+'px';this.tipElement.style.top=Math.round(top)+'px'},positionTrackTip:function(position){this.tipElement.style.display='block';var tipRect=this.tipElement.getBoundingClientRect();var left=position.x+this.config.trackOffset.x;var top=position.y+this.config.trackOffset.y;if(this.config.checkViewport){var viewportWidth=window.innerWidth;var viewportHeight=window.innerHeight;left=Math.max(0,Math.min(left,viewportWidth-tipRect.width));top=Math.max(0,Math.min(top,viewportHeight-tipRect.height))}this.tipElement.style.left=Math.round(left+(position.scrollX||0))+'px';this.tipElement.style.top=Math.round(top+(position.scrollY||0))+'px'},update:function(){this.setupEventListeners()},destroy:function(){this.removeEventListeners();if(this.scrollListener){window.removeEventListener('scroll',this.scrollListener)}if(this.resizeListener){window.removeEventListener('resize',this.resizeListener)}if(this.tipElement&&document.body.contains(this.tipElement)){document.body.removeChild(this.tipElement)}var elements=document.querySelectorAll('[data-tips]');for(var i=0;i<elements.length;i++){var el=elements[i];if(el.dataset.originalTitle){el.title=el.dataset.originalTitle;delete el.dataset.originalTitle;delete el.dataset.tipsInitialized}}this.tipElement=null;this.tipArrow=null;this.currentTarget=null;this.lastPosition=null}};var onPageLoad={_callbacks:{dom:[],all:[],dynamic:null},_observer:null,_loaded:{dom:false,all:false},on:function(type,callback){if(typeof type==='function'){callback=type;type='dom'}if(!this._initialized){this._init();this._initialized=true}this._register(type,callback);return this},onResize:function(element="body",callback){Functions.resizeDom(element,callback);return this},_register:function(type,callback){if(this._loaded[type]){callback();return}if(type==='dynamic'){this.watchDOM(callback);this._callbacks.dynamic=this._callbacks.dynamic||[];this._callbacks.dynamic.push(callback)}else{this._callbacks[type].push(callback)}},_init:function(){document.addEventListener('DOMContentLoaded',()=>{this._loaded.dom=true;this._trigger('dom');this._checkScripts()});window.addEventListener('load',()=>{this._loaded.all=true;this._trigger('all')})},watchDOM:function(callback,{root=document.body,childList=true,attributes=true,subtree=true,characterData=true,debounce=50}={}){if(typeof callback!=='function')throw new Error('回调必须是函数');if(!(root instanceof Node))throw new Error('root必须是DOM节点');let timer=null;const changes=new Map();const observer=new MutationObserver(mutations=>{mutations.forEach(mutation=>{if(mutation.type==='attributes'){const target=mutation.target;const attrName=mutation.attributeName;changes.set(target,{type:'attribute',target:target,attribute:attrName,oldValue:mutation.oldValue,newValue:target.getAttribute(attrName)})}else if(mutation.type==='characterData'){const parent=mutation.target.parentNode;changes.set(parent,{type:'text',target:parent,oldValue:mutation.oldValue,newValue:mutation.target.data})}else if(mutation.type==='childList'){mutation.removedNodes.forEach(node=>{if(node.nodeType===Node.ELEMENT_NODE){changes.set(node,{type:'removed',target:node,oldValue:node.cloneNode(true),newValue:null})}});mutation.addedNodes.forEach(node=>{if(node.nodeType===Node.ELEMENT_NODE){changes.set(node,{type:'added',target:node,oldValue:null,newValue:node.cloneNode(true)})}});if(mutation.target.nodeType===Node.ELEMENT_NODE){changes.set(mutation.target,{type:'parent',target:mutation.target,oldValue:mutation.previousSibling,newValue:mutation.nextSibling})}}});clearTimeout(timer);timer=setTimeout(()=>{if(changes.size>0){callback(Array.from(changes.values()));changes.clear()}},debounce)});const observerConfig={childList,attributes,attributeOldValue:attributes,subtree,characterData,characterDataOldValue:characterData};observer.observe(root,observerConfig);return()=>{clearTimeout(timer);observer.disconnect()}},_checkScripts:function(){var scripts=document.querySelectorAll('script[src]');var remaining=scripts.length;if(remaining===0){this._loaded.all=true;this._trigger('all');return}scripts.forEach(script=>{if(script.readyState==='loaded'||script.readyState==='complete'){if(--remaining===0)this._allScriptsLoaded()}else{script.addEventListener('load',()=>{if(--remaining===0)this._allScriptsLoaded()});script.addEventListener('error',()=>{if(--remaining===0)this._allScriptsLoaded()})}})},_allScriptsLoaded:function(){this._loaded.all=true;this._trigger('all')},_trigger:function(type){this._callbacks[type].forEach(fn=>{try{fn()}catch(e){console.error(e)}});this._callbacks[type]=[]},destroy:function(){if(this._observer){this._observer.disconnect();this._observer=null}this._callbacks={dom:[],all:[],dynamic:null};this._loaded={dom:false,all:false}}};const Message={_id:0,msg:function(msg,timer=3.5){const existingMsgBox=document.querySelector('.my-layer-msg-box');if(existingMsgBox){existingMsgBox.remove()}msg=msg||"操作成功";const random_id=Math.floor(Math.random()*999999999999)+1000000000000;const msgBox=document.createElement('div');msgBox.className='my-layer-msg-box my_layer';msgBox.id='my_layer_'+random_id;msgBox.textContent=msg;Object.assign(msgBox.style,{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%, -50%)',padding:'5px 15px',backgroundColor:'rgba(0,0,0,.6)',color:'#fff',border:'none',minWidth:'100px',wordBreak:'break-all',textAlign:'center',zIndex:'999',});document.body.appendChild(msgBox);if(timer>0){setTimeout(function(){const msgElement=document.getElementById('my_layer_'+random_id);if(msgElement){msgElement.remove()}},1000*timer)}this._id=random_id;return this},close:function(){const msgElement=document.getElementById('my_layer_'+this._id);if(msgElement){msgElement.remove()}},closeAll:function(){const msgElements=document.querySelectorAll('.my_layer');for(let i=0;i<msgElements.length;i++){msgElements[i].remove()}}};var EventHandle={init:function(){this.setCopyPreCodeBtn();this.initAjaxRequest()},initAjaxRequest:function(){const ajaxRequestLinks=document.querySelectorAll('a.ajax_request');ajaxRequestLinks.forEach(link=>{link.addEventListener('click',function(e){e.preventDefault();$.ajax({url:link.href,type:'POST',data:{},success:function(data){Message.msg(data.message||data.msg)},error:function(xhr,status,error){Message.msg(error)}})})})},setCopyPreCodeBtn:function(){const preElements=document.querySelectorAll('pre');preElements.forEach(pre=>{if(pre.querySelector('.copy-code-btn')){return}const copyBtn=document.createElement('button');copyBtn.className='copy-code-btn';copyBtn.textContent='复制';copyBtn.title='复制代码';pre.appendChild(copyBtn);copyBtn.addEventListener('click',()=>{let codeString=pre.querySelector('code')?pre.querySelector('code').textContent:pre.textContent;codeString=codeString.trimEnd().replace(/([\s\u3000]*复制[\s\u3000]*)$/,'').trimEnd();Functions.copyText(codeString,function(){copyBtn.textContent='已复制!';copyBtn.classList.add('copied');setTimeout(()=>{copyBtn.textContent='复制';copyBtn.classList.remove('copied')},3500)})})});const codeElements=document.querySelectorAll('code:not(pre code)');codeElements.forEach(codeElement=>{codeElement.addEventListener('click',()=>{Functions.copyText(codeElement.textContent)})})},};var Dom={query:function(selector,context){if(!selector){return[]}context=context||document;if(selector.nodeType===1){return[selector]}if(Array.isArray(selector)||selector instanceof NodeList){return Array.from(selector)}if(typeof selector==='string'){if(selector[0]==='#'&&!selector.match(/[ .<>:~]/)){const el=context.getElementById(selector.slice(1));return el?[el]:[]}try{return Array.from(context.querySelectorAll(selector))}catch(e){console.error(`无效的选择器:${selector}`);return[]}}console.error('不支持的选择器类型:',selector);return[]},on:function(element,events,selector,data,handler,one){if(typeof selector==='function'){handler=selector;data=undefined;selector=undefined}else if(typeof data==='function'){handler=data;data=undefined}if(typeof handler!=='function'){console.error('事件处理函数必须是一个函数');return}const eventList=events.split(' ').filter(e=>e.trim());if(eventList.length===0){console.error('未提供有效的事件名称');return}const elements=this.query(element);if(elements.length===0){console.warn('未找到匹配的元素');return}elements.forEach(el=>{eventList.forEach(eventName=>{this._addEventHandler(el,eventName,selector,data,handler,one)})})},_addEventHandler:function(el,eventName,selector,data,handler,one){const realHandler=function(e){let target=e.target;let currentTarget=el;if(selector){while(target&&target!==currentTarget){if(target.matches(selector)){currentTarget=target;break}target=target.parentNode}if(!target||(target===el&&!el.matches(selector))){return}}if(data!==undefined){e.data=data}const result=handler.call(currentTarget,e);if(one){this._removeEventHandler(el,eventName,realHandler)}return result};realHandler.originalHandler=handler;const eventKey=`DomEvent_${eventName}`;if(!el[eventKey]){el[eventKey]=[]}el[eventKey].push(realHandler);el.addEventListener(eventName,realHandler)},_removeEventHandler:function(el,eventName,handler){const eventKey=`DomEvent_${eventName}`;const handlers=el[eventKey]||[];for(let i=handlers.length-1;i>=0;i--){const h=handlers[i];if(!handler||h===handler||h.originalHandler===handler){el.removeEventListener(eventName,h);handlers.splice(i,1)}}if(handlers.length===0){delete el[eventKey]}else{el[eventKey]=handlers}},one:function(element,events,selector,data,handler){this.on(element,events,selector,data,handler,true)},off:function(element,events,selector,handler){if(typeof selector==='function'){handler=selector;selector=undefined}const elements=this.query(element);if(elements.length===0){console.warn('未找到匹配的元素');return}let eventList=[];if(events){eventList=events.split(' ').filter(e=>e.trim())}else{elements.forEach(el=>{eventList=eventList.concat(Object.keys(el).filter(key=>key.startsWith('DomEvent_')).map(key=>key.replace('DomEvent_','')))});eventList=[...new Set(eventList)]}if(eventList.length===0){console.warn('未提供有效的事件名称');return}elements.forEach(el=>{eventList.forEach(eventName=>{if(selector){const eventKey=`DomEvent_${eventName}`;const handlers=el[eventKey]||[];handlers.forEach(h=>{if(h.originalHandler===handler||(handler===undefined&&h.selector===selector)){this._removeEventHandler(el,eventName,h)}})}else{this._removeEventHandler(el,eventName,handler)}})})},trigger:function(element,eventName,extraParameters){const elements=this.query(element);if(elements.length===0){console.warn('未找到匹配的元素');return}if(!eventName){console.error('未提供事件名称');return}elements.forEach(el=>{let event;if(typeof CustomEvent==='function'){event=new CustomEvent(eventName,{bubbles:true,cancelable:true,detail:extraParameters})}else if(typeof Event==='function'){event=new Event(eventName,{bubbles:true,cancelable:true});if(extraParameters){event.detail=extraParameters;Object.assign(event,extraParameters)}}else{event=document.createEvent('Event');event.initEvent(eventName,true,true);if(extraParameters){event.detail=extraParameters;for(const key in extraParameters){if(!event[key]){event[key]=extraParameters[key]}}}}el.dispatchEvent(event)})}};['click','dblclick','mouseenter','mouseleave','mouseover','mouseout','mousedown','mouseup','mousemove','keydown','keypress','keyup','submit','change','focus','blur','focusin','focusout','resize','scroll','select','contextmenu'].forEach(function(eventName){Dom[eventName]=function(element,selector,data,handler){if(typeof selector==='function'){handler=selector;selector=undefined;data=undefined}else if(typeof data==='function'){handler=data;data=undefined}Dom.on(element,eventName,selector,data,handler)}});var myTools={form:FormHandle,func:Functions,http:HttpRequest,load:onPageLoad,dom:Dom,msg:(msg,timer=3.5)=>Message.msg(msg,timer),closeAllMsg:()=>Message.closeAll(),init:function(){FormHandle.init();SelectHandle.init();Tips.init();EventHandle.init()},};global.myTools=myTools;if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){myTools.init()})}else{myTools.init()}myTools.load.on('dom',function(){})}(window,document);
