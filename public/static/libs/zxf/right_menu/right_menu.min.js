class RightMenu{constructor(options={}){if(!options.selector){throw new Error('selector参数是必须的');}if(!options.menus||!Array.isArray(options.menus)){throw new Error('menus参数必须是数组');}this.config={selector:options.selector,itemWidth:options.itemWidth||160,longPressTime:options.longPressTime||1400,zIndex:options.zIndex||9999,animationDuration:options.animationDuration||200,menuClass:'right-menu-'+Math.random().toString(36).substr(2,9)};this.menus=options.menus;this.isMobile=this._checkMobile();this.activeElement=null;this.currentMenu=null;this.timer=null;this.longPressing=false;this.lastTouchPos={x:0,y:0};this._init()}_checkMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}_init(){this._createMenuContainer();this._bindEvents()}_createMenuContainer(){this.menuContainer=document.createElement('div');this.menuContainer.className='right-menu-container '+this.config.menuClass;this.menuContainer.style.display='none';this.menuContainer.style.zIndex=this.config.zIndex;document.body.appendChild(this.menuContainer)}_bindEvents(){const elements=document.querySelectorAll(this.config.selector);elements.forEach(el=>{el.addEventListener('contextmenu',this._handleContextMenu.bind(this));if(this.isMobile){el.addEventListener('touchstart',this._handleTouchStart.bind(this),{passive:false});el.addEventListener('touchend',this._handleTouchEnd.bind(this));el.addEventListener('touchmove',this._handleTouchMove.bind(this));el.addEventListener('touchcancel',this._handleTouchEnd.bind(this))}});document.addEventListener('click',this._handleDocumentClick.bind(this),true);document.addEventListener('scroll',this._handleDocumentScroll.bind(this),true)}_handleContextMenu(e){e.preventDefault();e.stopPropagation();this._showMenu(e,e.clientX,e.clientY)}_handleTouchStart(e){e.preventDefault();e.stopPropagation();const touch=e.touches[0]||e.changedTouches[0];this.lastTouchPos={x:touch.clientX,y:touch.clientY};this.longPressing=false;this.timer=setTimeout(()=>{this.longPressing=true;this._showMenu(e,this.lastTouchPos.x,this.lastTouchPos.y)},this.config.longPressTime)}_handleTouchEnd(e){clearTimeout(this.timer);if(!this.longPressing){const clickEvent=new MouseEvent('click',{bubbles:true,cancelable:true,view:window});e.target.dispatchEvent(clickEvent)}this.longPressing=false}_handleTouchMove(e){const touch=e.touches[0]||e.changedTouches[0];const dx=touch.clientX-this.lastTouchPos.x;const dy=touch.clientY-this.lastTouchPos.y;const distance=Math.sqrt(dx*dx+dy*dy);if(distance>10){clearTimeout(this.timer)}}_handleDocumentClick(e){if(!this.menuContainer.contains(e.target)){this._hideMenu()}}_handleDocumentScroll(){this._hideMenu()}_showMenu(dom,x,y){this._hideMenu();this.activeElement=dom;this.currentMenu=this._createMenu(this.menus,1);this.menuContainer.innerHTML='';this.menuContainer.appendChild(this.currentMenu);this._positionMenu(this.currentMenu,x,y);this.menuContainer.style.display='block';document.body.style.overflow='hidden'}_hideMenu(){if(this.menuContainer){this.menuContainer.style.display='none';this.menuContainer.innerHTML='';this.currentMenu=null;this.activeElement=null;document.body.style.overflow=''}}_createMenu(items,level){const menu=document.createElement('ul');menu.className=`right-menu level-${level}`;menu.style.width=`${this.config.itemWidth}px`;menu.style.transition=`opacity ${this.config.animationDuration}ms ease,transform ${this.config.animationDuration}ms ease`;if(level>1){menu.style.opacity='0';menu.style.transform='scale(0.95)'}items.forEach(item=>{if(item==='divider'){const divider=document.createElement('li');divider.className='right-menu-divider';menu.appendChild(divider)}else{const menuItem=document.createElement('li');menuItem.className='right-menu-item';const content=document.createElement('div');content.className='right-menu-content';if(item.icon){const icon=document.createElement('span');icon.className='right-menu-icon';icon.innerHTML=item.icon;content.appendChild(icon)}const text=document.createElement('span');text.className='right-menu-text';text.textContent=item.text;content.appendChild(text);if(item.children&&item.children.length>0){const arrow=document.createElement('span');arrow.className='right-menu-arrow';arrow.innerHTML='&#9654;';content.appendChild(arrow)}menuItem.appendChild(content);menu.appendChild(menuItem);this._bindMenuItemEvent(menuItem,item,level)}});return menu}_bindMenuItemEvent(menuItem,item,level){menuItem.addEventListener('click',e=>{e.stopPropagation();if(item.children&&item.children.length>0){this._showSubMenu(menuItem,item.children,level+1)}else if(item.callback){item.callback(this.activeElement,item,this.activeElement.target);this._hideMenu()}})}_showSubMenu(parentItem,items,level){const parentMenu=parentItem.parentElement;const existingSubMenu=parentMenu.querySelector(`.level-${level}`);if(existingSubMenu){existingSubMenu.remove()}const subMenu=this._createMenu(items,level);const rect=parentItem.getBoundingClientRect();let left=rect.right;let top=rect.top;const viewportWidth=window.innerWidth;if(left+this.config.itemWidth>viewportWidth){if(rect.left-this.config.itemWidth>0){left=rect.left-this.config.itemWidth}else{subMenu.classList.add('vertical');left=rect.left+10}}const viewportHeight=window.innerHeight;const menuHeight=items.length*40;if(top+menuHeight>viewportHeight){top=Math.max(0,viewportHeight-menuHeight-10)}subMenu.style.left=`${left}px`;subMenu.style.top=`${top}px`;this.menuContainer.appendChild(subMenu);setTimeout(()=>{subMenu.style.opacity='1';subMenu.style.transform='scale(1)'},10)}_positionMenu(menu,x,y){const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;const menuWidth=this.config.itemWidth;const menuHeight=menu.children.length*40;if(x+menuWidth>viewportWidth){x=viewportWidth-menuWidth-10}x=Math.max(0,x);if(y+menuHeight>viewportHeight){y=viewportHeight-menuHeight-10}y=Math.max(0,y);menu.style.left=`${x}px`;menu.style.top=`${y}px`}updateMenus(menus){if(!Array.isArray(menus)){throw new Error('menus参数必须是数组');}this.menus=menus}destroy(){const elements=document.querySelectorAll(this.config.selector);elements.forEach(el=>{el.removeEventListener('contextmenu',this._handleContextMenu);if(this.isMobile){el.removeEventListener('touchstart',this._handleTouchStart);el.removeEventListener('touchend',this._handleTouchEnd);el.removeEventListener('touchmove',this._handleTouchMove);el.removeEventListener('touchcancel',this._handleTouchEnd)}});document.removeEventListener('click',this._handleDocumentClick);document.removeEventListener('scroll',this._handleDocumentScroll);if(this.menuContainer&&this.menuContainer.parentNode){this.menuContainer.parentNode.removeChild(this.menuContainer)}this.activeElement=null;this.currentMenu=null;clearTimeout(this.timer)}}
