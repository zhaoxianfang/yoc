class Modal{static instances=[];static minimizedModals=[];static toastContainers={};static zIndex=10000;static bodyScrollEnabled=true;constructor(options){this.options={title:'',content:'',width:'auto',height:'auto',buttons:[],position:'center',theme:'default',draggable:true,overlay:true,overlayClose:true,escClose:true,autoClose:0,showActionIcons:true,transparent:false,shake:false,buttonsAlign:'right',buttonsVertical:false,bodyScroll:false,loadingText:'加载中...',loadingSpinner:true,onOpen:null,onClose:null,onBeforeClose:null,onDrag:null,onMinimize:null,onMaximize:null,onRestore:null,onFullscreen:null,onIframeLoad:null,onIframeError:null,opacity:1,...options};this.id='zxf-modal-'+Math.random().toString(36).substr(2,9);this.isOpen=false;this.isMinimized=false;this.isMaximized=false;this.isFullscreen=false;this.originalWidth=this.options.width;this.originalHeight=this.options.height;this.originalPosition={top:0,left:0};this.timer=null;this.progressInterval=null;this.dragState={isDragging:false,startX:0,startY:0,startLeft:0,startTop:0};this._eventListeners={iframeLoad:[]};this._isIframeLoaded=false;this.init();Modal.instances.push(this)}init(){this.createModal();this.setupEvents()}onIframeComplete(callback){if(typeof callback!=='function'){console.warn('onIframeComplete 需要传入函数');return this}const wrappedCallback=()=>{try{callback(this)}catch(e){console.error('onIframeComplete 回调执行出错:',e)}};if(!this.iframe){console.warn('当前弹窗不包含 iframe');setTimeout(wrappedCallback,0);return this}if(this._isIframeLoaded){setTimeout(wrappedCallback,0)}else{this._eventListeners.iframeLoad.push(wrappedCallback)}return this}_triggerIframeLoad(){this._isIframeLoaded=true;this._eventListeners.iframeLoad.forEach(cb=>cb());this._eventListeners.iframeLoad=[]}createModal(){if(this.options.overlay){this.overlay=document.createElement('div');this.overlay.className='zxf-modal-overlay';document.body.appendChild(this.overlay)}this.modal=document.createElement('div');this.modal.className='zxf-modal-container';this.modal.id=this.id;if(this.options.theme){this.modal.classList.add(`zxf-modal-theme-${this.options.theme}`)}if(this.options.transparent){this.modal.classList.add('transparent');this.modal.style.opacity=this.options.opacity}if(this.options.width!=='auto'){this.modal.style.width=typeof this.options.width==='number'?`${this.options.width}px`:this.options.width}if(this.options.height!=='auto'){this.modal.style.height=typeof this.options.height==='number'?`${this.options.height}px`:this.options.height}if(!this.isTextOnlyAutoCloseModal()){if(this.options.showActionIcons){this.actions=document.createElement('div');this.actions.className='zxf-modal-actions';if((this.options.title!==false&&this.options.title.trim()!=='')||(this.options.buttons&&this.options.buttons.length>0)){this.minimizeBtn=document.createElement('button');this.minimizeBtn.className='zxf-modal-action-btn';this.minimizeBtn.innerHTML='&#x2015;';this.minimizeBtn.title='最小化';this.minimizeBtn.addEventListener('click',()=>this.minimize());this.actions.appendChild(this.minimizeBtn);this.maximizeBtn=document.createElement('button');this.maximizeBtn.className='zxf-modal-action-btn';this.maximizeBtn.innerHTML='&#x26F6;';this.maximizeBtn.title='最大化';this.maximizeBtn.addEventListener('click',()=>this.toggleMaximize());this.actions.appendChild(this.maximizeBtn)}if(this.options.autoClose<=0){this.closeBtn=document.createElement('button');this.closeBtn.className='zxf-modal-action-btn';this.closeBtn.innerHTML='&times;';this.closeBtn.title='关闭';this.closeBtn.addEventListener('click',()=>this.close());this.actions.appendChild(this.closeBtn)}this.modal.appendChild(this.actions)}}if((this.options.title!==false&&this.options.title.trim()!=='')&&!this.isTextOnlyAutoCloseModal()){this.header=document.createElement('div');this.header.className='zxf-modal-header';this.title=document.createElement('h3');this.title.className='zxf-modal-title';this.title.textContent=this.options.title;this.header.appendChild(this.title);this.modal.appendChild(this.header)}this.content=document.createElement('div');this.content.className='zxf-modal-content';this.setContent(this.options.content);this.modal.appendChild(this.content);if(this.options.buttons&&this.options.buttons.length>0&&!this.isTextOnlyAutoCloseModal()){this.createFooter()}if(this.options.autoClose>0){this.createProgressBar()}document.body.appendChild(this.modal);this.setPosition(this.options.position);Modal.zIndex+=1;this.modal.style.zIndex=Modal.zIndex;if(this.overlay){this.overlay.style.zIndex=Modal.zIndex-1}if(this.options.shake){this.shake()}}createLoadingIndicator(){if(this.loadingIndicator&&this.loadingIndicator.parentNode){this.loadingIndicator.parentNode.removeChild(this.loadingIndicator)}this.loadingIndicator=document.createElement('div');this.loadingIndicator.className='zxf-modal-loading-indicator';if(this.options.loadingSpinner!==false){const spinner=document.createElement('div');spinner.className='zxf-modal-loading-spinner';this.loadingIndicator.appendChild(spinner)}const text=document.createElement('div');text.className='zxf-modal-loading-text';text.textContent=this.options.loadingText||'加载中...';this.loadingIndicator.appendChild(text);this.content.appendChild(this.loadingIndicator);this.loadingIndicator.style.display='flex'}setupIframeLoadingState(){if(!this.iframe)return;this.loadingIndicator.style.display='flex';const handleLoad=()=>{this._triggerIframeLoad();if(this.options.onIframeLoad){this.options.onIframeLoad(this)}this.hideLoadingIndicator()};const handleError=()=>{this.showLoadingError();if(this.options.onIframeError){this.options.onIframeError(this)}};this.iframe.addEventListener('load',handleLoad);this.iframe.addEventListener('error',handleError);if(this.iframe.contentDocument&&this.iframe.contentDocument.readyState==='complete'){setTimeout(handleLoad,0)}}hideLoadingIndicator(){if(this.loadingIndicator){this.loadingIndicator.style.display='none'}}showLoadingError(){if(this.loadingIndicator){this.loadingIndicator.innerHTML='';const errorIcon=document.createElement('div');errorIcon.className='zxf-modal-loading-error';errorIcon.textContent='⚠️';this.loadingIndicator.appendChild(errorIcon);const errorText=document.createElement('div');errorText.className='zxf-modal-loading-text';errorText.textContent='加载失败';this.loadingIndicator.appendChild(errorText)}}isTextOnlyAutoCloseModal(){return this.options.autoClose>0&&(this.options.title===false||this.options.title==='')&&(!this.options.buttons||this.options.buttons.length===0)}createFooter(){this.footer=document.createElement('div');this.footer.className='zxf-modal-footer';if(this.options.buttonsAlign==='left'){this.footer.classList.add('buttons-left')}else if(this.options.buttonsAlign==='center'){this.footer.classList.add('buttons-center')}if(this.options.buttonsVertical){this.footer.classList.add('buttons-vertical')}this.options.buttons.forEach(btnConfig=>{const btn=document.createElement(btnConfig.href?'a':'button');btn.className='btn';if(btnConfig.type){btn.classList.add(`btn-${btnConfig.type}`)}if(btnConfig.href){btn.href=btnConfig.href;if(btnConfig.target){btn.target=btnConfig.target}btn.classList.add('btn-link')}btn.textContent=btnConfig.text;if(btnConfig.class){btn.classList.add(btnConfig.class)}if(btnConfig.click){btn.addEventListener('click',(e)=>{if(btnConfig.href&&e.preventDefault){e.preventDefault()}const result=btnConfig.click(e,this);if(result===false){return}if(btnConfig.close!==false&&result!=='keep-open'){this.close()}})}else if(!btnConfig.href){btn.addEventListener('click',()=>{if(btnConfig.close!==false){this.close()}})}this.footer.appendChild(btn)});this.modal.appendChild(this.footer)}createProgressBar(){this.progress=document.createElement('div');this.progress.className='zxf-modal-progress';this.progressBar=document.createElement('div');this.progressBar.className='zxf-modal-progress-bar';this.progress.appendChild(this.progressBar);this.modal.appendChild(this.progress)}setupEvents(){if(this.options.draggable&&(this.header||this.modal)){const dragHandle=this.header||this.modal;dragHandle.style.cursor='move';dragHandle.addEventListener('mousedown',(e)=>{if(e.target.tagName==='BUTTON'||e.target.tagName==='A'){return}e.preventDefault();this.dragState.isDragging=true;this.dragState.startX=e.clientX;this.dragState.startY=e.clientY;const rect=this.modal.getBoundingClientRect();this.dragState.startLeft=rect.left;this.dragState.startTop=rect.top;this.modal.style.transition='none';document.addEventListener('mousemove',this.handleDragMove);document.addEventListener('mouseup',this.handleDragEnd)});this.handleDragMove=(e)=>{if(!this.dragState.isDragging)return;const dx=e.clientX-this.dragState.startX;const dy=e.clientY-this.dragState.startY;const newLeft=this.dragState.startLeft+dx;const newTop=this.dragState.startTop+dy;this.modal.style.left=`${newLeft}px`;this.modal.style.top=`${newTop}px`;this.modal.style.right='auto';this.modal.style.bottom='auto';this.modal.style.transform='none';if(this.options.onDrag){this.options.onDrag({left:newLeft,top:newTop},this)}};this.handleDragEnd=()=>{this.dragState.isDragging=false;this.modal.style.transition='';document.removeEventListener('mousemove',this.handleDragMove);document.removeEventListener('mouseup',this.handleDragEnd)}}if(this.options.escClose){this.handleKeyDown=(e)=>{if(e.key==='Escape'){this.close()}};document.addEventListener('keydown',this.handleKeyDown)}if(this.options.overlay&&this.options.overlayClose){this.overlay.addEventListener('click',(e)=>{if(e.target===this.overlay){this.close()}})}}setupIframeEvents(){if(!this.iframe)return;window.addEventListener('message',(e)=>{if(e.data&&e.data.type==='close'){this.close();return}if(typeof receiveModalData==='function'){receiveModalData(e.data)}});this.iframe.addEventListener('load',()=>{try{const iframeDoc=this.iframe.contentDocument||this.iframe.contentWindow?.document;if(iframeDoc){this.handleIframeContent(iframeDoc);if(iframeDoc.readyState==='complete'){const script=iframeDoc.createElement('script');script.type='text/javascript';script.text=`window.addEventListener('message',(e)=>{console.log(e);if(e.data.type==='func'){}});`;iframeDoc.body.appendChild(script)}}}catch(e){console.warn('无法直接访问iframe内容:',e.message)}finally{this.hideLoadingIndicator()}});const resizeObserver=new ResizeObserver(()=>{if(this.iframe){this.iframe.style.width='100%';this.iframe.style.height='100%'}});resizeObserver.observe(this.modal)}callIframeFunction(funcName,...args){if(this.iframe){this.iframe.contentWindow[funcName](...args)}}handleIframeContent(iframeDoc){const observer=new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{if(mutation.type==='childList'||(mutation.type==='attributes'&&mutation.target.classList.contains('layer-bottom-btns'))){this.syncButtonsFromIframe(iframeDoc)}})});observer.observe(iframeDoc,{childList:true,subtree:true,attributes:true,attributeFilter:['class']});this.iframeObserver=observer;this.syncButtonsFromIframe(iframeDoc)}syncButtonsFromIframe(iframeDoc){const bottomBtns=iframeDoc.querySelector('.layer-bottom-btns');if(!bottomBtns)return;bottomBtns.style.display='none';if(!this.footer){this.createFooter()}this.footer.innerHTML='';const buttons=Array.from(bottomBtns.querySelectorAll('button, a'));buttons.forEach(originalBtn=>{const proxyBtn=document.createElement(originalBtn.tagName.toLowerCase());Array.from(originalBtn.attributes).forEach(attr=>{proxyBtn.setAttribute(attr.name,attr.value)});proxyBtn.className=originalBtn.className;proxyBtn.textContent=originalBtn.textContent;proxyBtn.style.cssText=originalBtn.style.cssText;if(originalBtn.onclick){proxyBtn.onclick=originalBtn.onclick}if(originalBtn.onmouseover){proxyBtn.onmouseover=originalBtn.onmouseover}if(originalBtn.hasAttribute('onclick')&&originalBtn.getAttribute('onclick').includes('parent.postMessage')){const originalOnclick=originalBtn.getAttribute('onclick');proxyBtn.setAttribute('onclick',originalOnclick)}this.footer.appendChild(proxyBtn)})}setPosition(position){if(this.isMaximized||this.isFullscreen)return;const rect=this.modal.getBoundingClientRect();const windowWidth=window.innerWidth;const windowHeight=window.innerHeight;this.modal.style.position='fixed';this.modal.style.transform='none';switch(position){case'top-left':this.modal.style.left='15px';this.modal.style.top='15px';this.modal.style.right='auto';this.modal.style.bottom='auto';break;case'top-right':this.modal.style.right='15px';this.modal.style.top='15px';this.modal.style.left='auto';this.modal.style.bottom='auto';break;case'bottom-left':this.modal.style.left='15px';this.modal.style.bottom='15px';this.modal.style.right='auto';this.modal.style.top='auto';break;case'bottom-right':this.modal.style.right='15px';this.modal.style.bottom='15px';this.modal.style.left='auto';this.modal.style.top='auto';break;case'top':this.modal.style.left='50%';this.modal.style.top='15px';this.modal.style.transform='translateX(-50%)';this.modal.style.right='auto';this.modal.style.bottom='auto';break;case'bottom':this.modal.style.left='50%';this.modal.style.bottom='15px';this.modal.style.transform='translateX(-50%)';this.modal.style.right='auto';this.modal.style.top='auto';break;case'left':this.modal.style.left='15px';this.modal.style.top='50%';this.modal.style.transform='translateY(-50%)';this.modal.style.right='auto';this.modal.style.bottom='auto';break;case'right':this.modal.style.right='15px';this.modal.style.top='50%';this.modal.style.transform='translateY(-50%)';this.modal.style.left='auto';this.modal.style.bottom='auto';break;case'center':default:this.modal.style.left='50%';this.modal.style.top='50%';this.modal.style.transform='translate(-50%, -50%)';this.modal.style.right='auto';this.modal.style.bottom='auto';break}}open(){if(this.isOpen)return;if(this.options.onOpen){const result=this.options.onOpen(this);if(result===false)return}this.isOpen=true;if(!this.options.bodyScroll){document.body.style.overflow='hidden'}if(this.overlay){this.overlay.classList.add('active')}this.modal.classList.add('active');if(this.options.autoClose>0){this.startAutoCloseTimer()}return this}startAutoCloseTimer(){if(this.timer){clearTimeout(this.timer)}if(this.progressInterval){clearInterval(this.progressInterval)}const duration=this.options.autoClose;let remaining=duration;if(this.progressBar){this.progressBar.style.width='100%';this.progressBar.style.transition=`width ${duration}ms linear`;setTimeout(()=>{this.progressBar.style.width='0%'},10)}this.timer=setTimeout(()=>{this.close()},duration)}close(){if(this.options.onBeforeClose){const result=this.options.onBeforeClose(this);if(result===false)return}if(this.iframeObserver){this.iframeObserver.disconnect();this.iframeObserver=null}this.isOpen=false;if(!this.options.bodyScroll){document.body.style.overflow=''}if(this.timer){clearTimeout(this.timer);this.timer=null}if(this.progressInterval){clearInterval(this.progressInterval);this.progressInterval=null}this.modal.classList.remove('active');if(this.overlay){this.overlay.classList.remove('active')}setTimeout(()=>{if(this.modal.parentNode){this.modal.parentNode.removeChild(this.modal)}if(this.overlay&&this.overlay.parentNode){this.overlay.parentNode.removeChild(this.overlay)}if(this.options.escClose){document.removeEventListener('keydown',this.handleKeyDown)}if(this.options.draggable){document.removeEventListener('mousemove',this.handleDragMove);document.removeEventListener('mouseup',this.handleDragEnd)}if(this.options.onClose){this.options.onClose(this)}const index=Modal.instances.indexOf(this);if(index!==-1){Modal.instances.splice(index,1)}},300);return this}minimize(){if(this.isMinimized)return;this.originalPosition={top:this.modal.style.top,left:this.modal.style.left,right:this.modal.style.right,bottom:this.modal.style.bottom,transform:this.modal.style.transform};this.originalWidth=this.modal.style.width;this.originalHeight=this.modal.style.height;this.minimizedElement=document.createElement('div');this.minimizedElement.className='zxf-modal-minimized';this.minimizedElement.dataset.modalId=this.id;const title=document.createElement('span');title.className='zxf-modal-minimized-title';title.textContent=this.options.title||'已最小化';const restoreBtn=document.createElement('button');restoreBtn.className='zxf-modal-minimized-restore';restoreBtn.textContent='恢复';restoreBtn.addEventListener('click',(e)=>{e.stopPropagation();this.restore()});this.minimizedElement.appendChild(title);this.minimizedElement.appendChild(restoreBtn);const minimizedContainer=document.getElementById('zxf-modal-minimized-container')||this.createMinimizedContainer();minimizedContainer.appendChild(this.minimizedElement);this.modal.style.display='none';if(this.overlay){this.overlay.style.display='none'}this.isMinimized=true;if(this.options.onMinimize){this.options.onMinimize(this)}this.minimizedElement.addEventListener('click',(e)=>{if(e.target.tagName!=='BUTTON'){this.restore()}});Modal.minimizedModals.push(this)}createMinimizedContainer(){const container=document.createElement('div');container.id='zxf-modal-minimized-container';container.style.position='fixed';container.style.bottom='15px';container.style.left='15px';container.style.display='flex';container.style.flexDirection='column';container.style.gap='8px';container.style.zIndex='99999';document.body.appendChild(container);return container}restore(){if(!this.isMinimized&&!this.isMaximized&&!this.isFullscreen)return;this.modal.classList.remove('fullscreen','maximized');this.modal.style.display='';if(this.overlay){this.overlay.style.display=''}this.modal.style.top=this.originalPosition.top;this.modal.style.left=this.originalPosition.left;this.modal.style.right=this.originalPosition.right;this.modal.style.bottom=this.originalPosition.bottom;this.modal.style.transform=this.originalPosition.transform;this.modal.style.width=this.originalWidth;this.modal.style.height=this.originalHeight;this.modal.style.borderRadius='';if(this.maximizeBtn){this.maximizeBtn.innerHTML='&#x26F6;';this.maximizeBtn.title='最大化'}if(this.minimizedElement&&this.minimizedElement.parentNode){this.minimizedElement.parentNode.removeChild(this.minimizedElement)}this.isMinimized=false;this.isMaximized=false;this.isFullscreen=false;const index=Modal.minimizedModals.indexOf(this);if(index!==-1){Modal.minimizedModals.splice(index,1)}if(Modal.minimizedModals.length===0){const container=document.getElementById('zxf-modal-minimized-container');if(container){container.parentNode.removeChild(container)}}if(this.options.onRestore){this.options.onRestore(this)}}toggleMaximize(){if(this.isMaximized){this.restore()}else{this.maximize()}}maximize(){if(this.isMaximized||this.isFullscreen)return;this.originalWidth=this.modal.style.width;this.originalHeight=this.modal.style.height;this.originalPosition={top:this.modal.style.top,left:this.modal.style.left,right:this.modal.style.right,bottom:this.modal.style.bottom,transform:this.modal.style.transform};this.modal.classList.add('maximized');this.modal.style.width='calc(100vw - 0px)';this.modal.style.height='calc(100vh - 0px)';this.modal.style.top='15px';this.modal.style.left='15px';this.modal.style.margin='auto';this.modal.style.transform='none';this.modal.style.right='auto';this.modal.style.bottom='auto';this.modal.style.inset='0';this.isMaximized=true;if(this.maximizeBtn){this.maximizeBtn.innerHTML='&#10064;';this.maximizeBtn.title='恢复'}if(this.options.onMaximize){this.options.onMaximize(this)}}fullscreen(){if(this.isFullscreen)return;this.originalWidth=this.modal.style.width;this.originalHeight=this.modal.style.height;this.originalPosition={top:this.modal.style.top,left:this.modal.style.left,right:this.modal.style.right,bottom:this.modal.style.bottom,transform:this.modal.style.transform};this.modal.classList.add('fullscreen');this.modal.style.width='100vw';this.modal.style.height='100vh';this.modal.style.top='0';this.modal.style.left='0';this.modal.style.transform='none';this.modal.style.right='auto';this.modal.style.bottom='auto';this.modal.style.borderRadius='0';this.modal.style.inset='0';this.modal.style.margin='0';this.isFullscreen=true;if(this.options.onFullscreen){this.options.onFullscreen(this)}}setContent(content){this.options.content=content;this.content.innerHTML='';if(typeof content==='string'){if(content.startsWith('<iframe ')){const iframeContainer=document.createElement('div');iframeContainer.className='zxf-modal-iframe-container';iframeContainer.innerHTML=content;this.content.appendChild(iframeContainer);this.iframe=iframeContainer.querySelector('iframe');this.createLoadingIndicator();this.setupIframeLoadingState();this.setupIframeEvents()}else{this.content.innerHTML=content}}else if(content instanceof HTMLElement){this.content.appendChild(content)}else if(typeof content==='function'){const contentResult=content();if(contentResult instanceof HTMLElement){this.content.appendChild(contentResult)}else{this.content.innerHTML=contentResult}}return this}setTitle(title){this.options.title=title;if(this.title){this.title.textContent=title}else if((title!==false&&title.trim()!=='')&&!this.isTextOnlyAutoCloseModal()){this.header=document.createElement('div');this.header.className='zxf-modal-header';this.title=document.createElement('h3');this.title.className='zxf-modal-title';this.title.textContent=title;this.header.appendChild(this.title);this.modal.insertBefore(this.header,this.content)}return this}shake(){this.setPosition('center');this.modal.classList.add('zxf-modal-shake');setTimeout(()=>{this.modal.classList.remove('zxf-modal-shake')},400)}static closeAll(){Modal.instances.slice().forEach(modal=>modal.close())}static minimizeAll(){Modal.instances.forEach(modal=>{if(!modal.isMinimized){modal.minimize()}})}static restoreAll(){Modal.minimizedModals.slice().forEach(modal=>modal.restore())}static toast(options){const defaults={message:'',type:'info',position:'top-right',timeout:5000,closeButton:true,progressBar:true,newestOnTop:true,onClick:null,onClose:null};const config={...defaults,...options};if(!Modal.toastContainers[config.position]){const container=document.createElement('div');container.className='zxf-modal-toast-container';container.style.position='fixed';switch(config.position){case'top-right':container.style.top='15px';container.style.right='15px';container.style.left='auto';container.style.bottom='auto';container.style.alignItems='flex-end';break;case'top-left':container.style.top='15px';container.style.left='15px';container.style.right='auto';container.style.bottom='auto';container.style.alignItems='flex-start';break;case'bottom-right':container.style.bottom='15px';container.style.right='15px';container.style.top='auto';container.style.left='auto';container.style.alignItems='flex-end';break;case'bottom-left':container.style.bottom='15px';container.style.left='15px';container.style.top='auto';container.style.right='auto';container.style.alignItems='flex-start';break;case'top-center':container.style.top='15px';container.style.left='50%';container.style.right='auto';container.style.bottom='auto';container.style.transform='translateX(-50%)';container.style.alignItems='center';break;case'bottom-center':container.style.bottom='15px';container.style.left='50%';container.style.top='auto';container.style.right='auto';container.style.transform='translateX(-50%)';container.style.alignItems='center';break;case'center':container.style.bottom='50%';container.style.left='50%';container.style.top='auto';container.style.right='auto';container.style.transform='translateX(-50%)';container.style.alignItems='center';break}document.body.appendChild(container);Modal.toastContainers[config.position]=container}const toast=document.createElement('div');toast.className='zxf-modal-toast toast-'+config.type+' '+config.position;const iconMap={success:'✓',error:'✕',info:'ℹ',warning:'⚠'};if(iconMap[config.type]){const icon=document.createElement('span');icon.className='toast-icon';icon.textContent=iconMap[config.type];toast.appendChild(icon)}const message=document.createElement('span');message.textContent=config.message;toast.appendChild(message);if(config.closeButton){const closeBtn=document.createElement('button');closeBtn.className='toast-close';closeBtn.innerHTML='&times;';closeBtn.addEventListener('click',()=>{toast.classList.remove('show');setTimeout(()=>{toast.remove();if(config.onClose){config.onClose()}},300)});toast.appendChild(closeBtn)}if(config.progressBar&&config.timeout>0){const progressContainer=document.createElement('div');progressContainer.className='toast-progress';const progressBar=document.createElement('div');progressBar.className='toast-progress-bar';progressBar.style.width='100%';progressBar.style.transition=`width ${config.timeout}ms linear`;progressContainer.appendChild(progressBar);toast.appendChild(progressContainer);setTimeout(()=>{progressBar.style.width='0%'},10)}if(config.onClick){toast.style.cursor='pointer';toast.addEventListener('click',config.onClick)}const container=Modal.toastContainers[config.position];if(config.newestOnTop){container.insertBefore(toast,container.firstChild)}else{container.appendChild(toast)}setTimeout(()=>{toast.classList.add('show')},10);if(config.timeout>0){const timer=setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>{toast.remove();if(config.onClose){config.onClose()}},300)},config.timeout);toast.dataset.timer=timer}return{element:toast,remove:()=>{clearTimeout(toast.dataset.timer);toast.classList.remove('show');setTimeout(()=>{toast.remove();if(config.onClose){config.onClose()}},300)}}}static iframe(title='信息',url='',width=600,height=400,style='width:100%;height:100%;'){return new Modal({title:title,content:`<iframe src="${url || 'about:blank'}"style="${style}"loading="lazy"></iframe>`,width:width,height:height,bodyScroll:false,loadingText:'加载中...',loadingSpinner:true,onBeforeClose:()=>{},onIframeLoad:(_modal)=>{},}).open()}static success(message,options={}){return Modal.toast({...options,message,type:'success'})}static error(message,options={}){return Modal.toast({...options,message,type:'error'})}static info(message,options={}){return Modal.toast({...options,message,type:'info'})}static warning(message,options={}){return Modal.toast({...options,message,type:'warning'})}static tips(message,options={}){options.position='center';return Modal.toast({...options,message,type:'info'})}static removeAllToasts(){Object.values(Modal.toastContainers).forEach(container=>{container.innerHTML=''})}static form(options={}){const{title,fields=[],labelAlign='left',labelWidth=150,darkTheme=false,buttons,disabled=false,onSubmit,...otherOptions}=options;const defaultButtons=[{text:'取消',type:'secondary',close:true},{text:'确认',type:'primary',click:(e,modal)=>{const formData=modal.getFormData();const isValid=modal.validateForm();if(isValid&&modal.options.onSubmit){const result=modal.options.onSubmit(formData,modal);return false}return isValid?true:'keep-open'}}];const modal=new Modal({title:title,buttons:buttons||defaultButtons,disabled:disabled,onSubmit:onSubmit,labelAlign:labelAlign,labelWidth:labelWidth,darkTheme:darkTheme,...otherOptions});modal.validateForm=function(){if(!this.form)return true;let isValid=true;this.formFields.forEach(field=>{const{name,required}=field;const formItem=this.form.querySelector(`.zxf-modal-form-item[data-name="${name}"]`);if(!formItem||!required)return;let fieldValid=true;const value=this.getFormData()[name];if(Array.isArray(value)){fieldValid=value.length>0}else{fieldValid=value!==''&&value!==null&&value!==undefined}if(!fieldValid){formItem.classList.add('error');isValid=false}else{formItem.classList.remove('error')}});return isValid};modal.getFormData=function(){const formData={};if(!this.form)return formData;this.formFields.forEach(field=>{const{name,type}=field;if(type==='checkbox'&&field.options&&field.options.length>1){const checkboxes=this.form.querySelectorAll(`input[name="${name}[]"]:checked`);formData[name]=Array.from(checkboxes).map(cb=>cb.value)}else if(type==='checkbox'){const checkbox=this.form.querySelector(`input[name="${name}"]`);formData[name]=checkbox?checkbox.checked:false}else if(type==='radio'){const radio=this.form.querySelector(`input[name="${name}"]:checked`);formData[name]=radio?radio.value:null}else if(type==='select'&&field.multiple){const select=this.form.querySelector(`select[name="${name}"]`);formData[name]=select?Array.from(select.selectedOptions).map(opt=>opt.value):[]}else{const input=this.form.querySelector(`[name="${name}"]`);if(input){formData[name]=input.value}}});return formData};modal.setFormContent=function(fields,labelAlign='left',labelWidth=150,darkTheme=false,disabled=false){const form=document.createElement('form');form.className=`zxf-modal-form zxf-modal-form-label-${labelAlign}`;if(darkTheme){form.classList.add('zxf-modal-form-dark');this.modal.classList.add('zxf-modal-theme-dark')}if(labelAlign==='left'){form.style.setProperty('--label-width',typeof labelWidth==='number'?`${labelWidth}px`:labelWidth)}fields.forEach(fieldConfig=>{const formItem=this.createFormItem(fieldConfig,disabled);if(formItem){form.appendChild(formItem)}});this.content.innerHTML='';this.content.appendChild(form);this.form=form;this.formFields=fields};modal.createFormItem=function(fieldConfig,parentDisabled=false){const{type,name,label,placeholder,required,options,default:defaultValue,disabled=false,multiple=false}=fieldConfig;const formItem=document.createElement('div');formItem.className='zxf-modal-form-item';formItem.dataset.name=name;if(parentDisabled||disabled){formItem.classList.add('disabled')}if(label){const labelEl=document.createElement('label');labelEl.className='zxf-modal-form-label';labelEl.textContent=label;if(required){labelEl.innerHTML+='<span style="color:#f56c6c"> *</span>'}formItem.appendChild(labelEl)}const controlContainer=document.createElement('div');controlContainer.className='zxf-modal-form-control';switch(type){case'text':case'password':case'email':case'number':case'input':const input=document.createElement('input');input.type=type==='input'?'text':type;input.name=name;input.placeholder=placeholder||'';input.value=defaultValue!==undefined?defaultValue:'';if(required)input.required=true;if(parentDisabled||disabled)input.disabled=true;controlContainer.appendChild(input);break;case'textarea':const textarea=document.createElement('textarea');textarea.name=name;textarea.placeholder=placeholder||'';textarea.value=defaultValue!==undefined?defaultValue:'';if(required)textarea.required=true;if(parentDisabled||disabled)textarea.disabled=true;controlContainer.appendChild(textarea);break;case'select':const select=document.createElement('select');select.name=name;if(multiple){select.multiple=true;select.size=Math.min(options?.length||5,10)}if(parentDisabled||disabled)select.disabled=true;if(placeholder&&!multiple){const placeholderOption=document.createElement('option');placeholderOption.value='';placeholderOption.textContent=placeholder;placeholderOption.disabled=true;placeholderOption.selected=defaultValue===undefined;select.appendChild(placeholderOption)}if(options&&Array.isArray(options)){options.forEach(opt=>{const option=document.createElement('option');option.value=opt.value;option.textContent=opt.label||opt.value;if(defaultValue!==undefined){if(multiple&&Array.isArray(defaultValue)){option.selected=defaultValue.includes(opt.value)}else if(!multiple&&defaultValue===opt.value){option.selected=true}}select.appendChild(option)})}controlContainer.appendChild(select);break;case'radio':if(options&&Array.isArray(options)){const radioGroup=document.createElement('div');radioGroup.className='zxf-modal-form-radio-group';options.forEach(opt=>{const radioItem=document.createElement('div');radioItem.className='zxf-modal-form-radio-item';if(parentDisabled||disabled)radioItem.style.pointerEvents='none';const radio=document.createElement('input');radio.type='radio';radio.name=name;radio.value=opt.value;radio.id=`${name}_${opt.value}`;if(defaultValue===opt.value)radio.checked=true;if(required)radio.required=true;if(parentDisabled||disabled)radio.disabled=true;const radioLabel=document.createElement('label');radioLabel.htmlFor=radio.id;radioLabel.textContent=opt.label||opt.value;radioItem.appendChild(radio);radioItem.appendChild(radioLabel);radioGroup.appendChild(radioItem)});controlContainer.appendChild(radioGroup)}break;case'checkbox':if(options&&Array.isArray(options)){const checkboxGroup=document.createElement('div');checkboxGroup.className='zxf-modal-form-checkbox-group';if(options.length>1){options.forEach(opt=>{const checkboxItem=document.createElement('div');checkboxItem.className='zxf-modal-form-checkbox-item';if(parentDisabled||disabled)checkboxItem.style.pointerEvents='none';const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.name=name+'[]';checkbox.value=opt.value;checkbox.id=`${name}_${opt.value}`;if(defaultValue!==undefined){if(Array.isArray(defaultValue)){checkbox.checked=defaultValue.includes(opt.value)}else if(defaultValue===opt.value){checkbox.checked=true}}if(parentDisabled||disabled)checkbox.disabled=true;const checkboxLabel=document.createElement('label');checkboxLabel.htmlFor=checkbox.id;checkboxLabel.textContent=opt.label||opt.value;checkboxItem.appendChild(checkbox);checkboxItem.appendChild(checkboxLabel);checkboxGroup.appendChild(checkboxItem)})}else{const checkboxItem=document.createElement('div');checkboxItem.className='zxf-modal-form-checkbox-item';if(parentDisabled||disabled)checkboxItem.style.pointerEvents='none';const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.name=name;checkbox.id=name;checkbox.value='1';if(defaultValue!==undefined){checkbox.checked=Boolean(defaultValue)}if(parentDisabled||disabled)checkbox.disabled=true;const checkboxLabel=document.createElement('label');checkboxLabel.htmlFor=checkbox.id;checkboxLabel.textContent=options[0].label||options[0].value;checkboxItem.appendChild(checkbox);checkboxItem.appendChild(checkboxLabel);checkboxGroup.appendChild(checkboxItem)}controlContainer.appendChild(checkboxGroup)}break;default:console.warn(`未知的表单字段类型:${type}`);return null}const errorEl=document.createElement('div');errorEl.className='zxf-modal-form-error';errorEl.textContent=required?'此项为必填项':'';controlContainer.appendChild(errorEl);formItem.appendChild(controlContainer);return formItem};modal.setFormContent(fields,labelAlign,labelWidth,darkTheme,disabled);return modal}}window.Modal=Modal;
