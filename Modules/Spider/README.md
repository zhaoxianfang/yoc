# 爬虫

```
php artisan module:make Spider
```

## 建表

```
php artisan module:make-migration create_spider_tasks_table Spider
```

## 执行迁移

```
php artisan module:migrate Spider
```

## 回滚

```
php artisan module:migrate-rollback Spider
```

## cron 规则

```
*   *   *   *   *   每分钟
*/2 *   *   *   *   每2分钟
0   *   *   *   *   每小时
17  *   *   *   *   每小时第17分钟
0   */2 *   *   *   每2小时
0   */6 *   *   *   每6小时
0   0   *   *   *   每天00:00分
0   13  *   *   *   每天 13:00 执行一次任务
25  13  *   *   *   每天 13:25 执行一次任务
0   1,13 *  *   *   每天 01:00 和 13:00 各执行一次任务
0   0   *   *   0   每周00:00分
0   8   *   *   1   每周一 08:00 执行一次任务
0   0   1   *   *   每月第一天 00:00 执行一次任务
0   15  4   *   *   每月第四天 15:00 执行一次任务
26  13  1,16 *  *   每月第一天和第 十六天的 13:26 各执行一次任务
5   15  31  *   *   每月最后一天 15:05 执行一次任务
0   0   1   1-12/3 * 每季度第一天 00:00 执行一次任务
0   0   1   1   *   每年第一天 00:00 执行一次任务
0   17  1   6   *   每年六月第一天 17:00 执行一次任务
|   |   |   |   └—— 周(天)
|   |   |   └—————— 月
|   |   └—————————— 月(天)
|   └—————————————— 时
└—————————————————— 分
```

cron 配置参见 https://crontab.guru/

### 参数说明

#### 分

```
说明：允许的值，0-59

* 每分钟; 
, 隔开指定哪几个分钟; 例如 0,15,30,45
- 连接周期时间; 例如 0-59 分钟
/ 每隔多少分钟; 例如 */2 每隔2分钟
```

#### 时

```
说明：允许的值，0-23

* 每分钟; 
, 隔开指定哪几个小时; 例如 0,15,20
- 连接周期时间; 例如 0-23 小时
/ 每隔多少小时; 例如 */2 每隔2小时
```

#### 月(天)

```
说明：允许的值，1-31

* 每天; 
, 隔开指定哪几个日期; 例如 0,15,30
- 连接周期时间; 例如 1-31 号
/ 每隔多少天; 例如 */2 每隔2天
```

#### 月

```
说明：允许的值，1-12 或者 JAN-DEC 

* 每分钟; 
, 隔开指定哪几个月; 例如 0,1,3,11
- 连接周期时间; 例如 1-12 月
/ 每隔多少分钟; 例如 */2 每隔2分钟
```

#### 周

```
说明：允许的值，0-6 或者 SUN-SAT，0 为星期天，1 为星期一，以此类推，7为非标准的周日

* 每分钟; 
, 隔开指定哪几个分钟; 例如 0,15,30,45
- 连接周期时间; 例如 0-6
/ 每隔多少分钟; 例如 */2 每隔2分钟
```

### demo

```
0 0 * * 0       // 表示每周一次
30 14 * * 3     // 每周三下午 14:30

* * * * * 每分钟
*/2 * * * * 每2分钟一次（每偶数分钟）
*/3 * * * * 每3分钟一次
*/30 * * * * 每30分钟一次
0 * * * * 每小时
0 0 * * * 每天0点
30 * * * * 每小时30分钟
0 */2 * * * 每2小时
0 */6 * * * 每6小时
0 1 * * * 每天1点
0 8 * * * 每天8点
0 9-17 * * * 每天9点到17点，每个整点
0 0 * * SUN 每周日0点 或 0 0 * * 0
0 0 * * MON 每周一0点 或 0 0 * * 1
0 0 * * TUE 每周二0点 或 0 0 * * 2
0 0 * * WED 每周三0点 或 0 0 * * 3
0 0 * * THU 每周四0点 或 0 0 * * 4
0 0 * * FRI 每周五0点 或 0 0 * * 5
0 0 * * SAT 每周六0点 或 0 0 * * 6
0 0 * * 1-5 每周一到周五0点
0 0 * * 6,0 每周六、周日0点
0 0 * * 0 每周日0点
0 0 1 * * 每月1号0点
0 0 1 */2 * 每二个月的第一天 00:00。注意第一个月是1月
0 0 1 */3 * 每三个月的第一天 00:00
0 0 1 */6 * 每六个月的第一天 00:00
0 0 1 1 * 每年1月1号0点
0 0 1 1,6 * 每年1月1号和6月1号0点
0 0 1 1-6 * 每年1月1号到6月1号每天0点

7 10 * * 4,0 每周四、周日10:07

0 0 * * * 每天
*/2 * * * * 每2分钟
*/3 * * * * 每3分钟
*/15 * * * * 每15分钟
0/30 * * * * 每30分钟
```

## 测试写入 爬虫任务

```
// 测试写入「单规则」和「多规则」爬虫任务
SpiderTask::create([
    'timer'            => '0 5 * * 1,4', // 表示每周一和周四早上5点0分执行
    'name'             => '国务院-最新政策',
    'url'              => 'http://www.gov.cn/zhengce/zuixin.htm',
    'type'             => SpiderTask::TYPE_LIST, // 1正文；2列表；3报刊；4其他
    'url_can_repeated' => 1, // 1允许重复采集；0不允许重复采集
    'rules'            => [
        // 方式一: 使用默认的清洗html，又只有一个采集规则 可用此方式
        'title' => '/html/body/div[3]/div/div/div[2]/div[1]/ul/li/h4/a' // 只有一种采集规则且需要进行清洗html内容
        // 方式二: 只设置采集规则列表，使用默认的清洗html
        'title'        => [
            "/html/body/div[6]/div[1]/div[2]/h1",
            "/html/body/div[6]/div[3]/table[1]/tbody/tr/td/table[1]/tbody/tr[3]/td[2]",
            "/html/body/div[3]/div[2]/div[1]/div[2]/h1",
            "/html/body/div[4]/div[1]/div[2]/h1",
        ],
        // 方式三:  设置采集是否需要清洗html,又使用单个规则方式设置采集规则项
        'title'      => [
            'field_handle' => 2, // 对采集到的内容处理；0:保留原格式 1:清洗html 2:取出时间字符,【默认清洗html】
            'route'        => '//*[@id="UCAP-CONTENT"]', // 采集规则使用字符串
        ],
        // 方式四:  既设置采集是否需要清洗html,又使用规则列表方式设置采集规则
        'title' => [ 
            'field_handle' => 2, // 对采集到的内容处理；0:保留原格式 1:清洗html 2:取出时间字符 3:纯text文字 4:正则原格式 5:正则text
            'route'      => [ // 规则路径 xpath 或者 css 选择器
                "/html/body/div[6]/div[1]/div[2]/div[1]/text()",
                "/html/body/div[6]/div[3]/table[1]/tbody/tr/td/table[1]/tbody/tr[4]/td[4]",
                "/html/body/div[3]/div[2]/div[1]/div[2]/div[1]/text()",
                "/html/body/div[4]/div[1]/div[2]/div[1]/text()",
            ],
            'extend'=> [ // 扩展字段(用于正则匹配)
                'first' => 2 // 【一般用于和title字段对应的内容】获取到网页后，使用 preg_match_all($pattern='传入的正则表达式', $htmlString, $matches, PREG_SET_ORDER, 0) 进行匹配，应该取 $matches 的 第几个下标元素
                'href' => 1  // 【可为空】【一般用于获取title字段对应的连接地址充当href 或url 使用】获取到网页后 使用上面的进行匹配，应该取 $matches 的 第几个下标元素
            ],
        ],
    ],
    'next_tasks_id'    => 2, // 下一个任务id，默认0
    'sub_tasks'        => 0, // 是否为子任务，默认0 1是0否
    'domain_prefix'    => '', // 域名拼接前缀
    'extend'           => [ // 扩展字段
        'classify_id'=>0 // 采集成功后保存的文章分类id
    ],
    'before'           => [],// 采集前的操作
    'after'            => [],// 采集后的操作
    'fail'             => [],// 采集失败时候的操作
    'success'          => [ // 列表采集成功后 的操作
        'save' => '' // 文章保存模型键名,空或者null 表示不保存数据到数据库
        // 'save' => 'default' // 使用默认的文章保存模型
        // 'save' => 'default' // 使用默认的文章保存模型
        // 'save' => 'article' // 指定使用article保存模型
    ],
    'status'           => 1, // 状态 1启用 2关闭
]);
```

## 执行任务调度

```
php artisan schedule:run

* * * * * cd /你的项目路径 && php artisan schedule:run >> /dev/null 2>&1

php artisan schedule:list
```

## 重启队列

```
php artisan queue:restart
```
